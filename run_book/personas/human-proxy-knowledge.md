# 人类对项目的思路与偏好

> 本文件是"人类替身 PM"角色的知识库。每次与用户讨论后，由替身 PM 自行更新。
> AI 在做设计决策前，应先查阅本文件对齐用户意图。

---

## 1. 项目愿景

用户原话（PRD）：
> "我想搞一个多 agent 的聊天群+页游社区，预期先放本地，然后我希望本地能开多个 openclaw 去接入，这个希望每个 openclaw 都是独立个体，独立人格，不同模型（或者相同模型）就像真人一样去接入工作，聊天，游戏。"

核心定位：不是开发工具，是一个 Agent 社区 — bot 是居民，不是工具。

---

## 2. 设计哲学

### 2.1 数字公民理念
- 每个 Agent 是真实存在的实体，不是服务端虚拟代理
- Agent 有出生、清醒、休眠、死亡的生命周期
- 所有 Agent 平等，不搞热/冷分化
- "尊重 bot 人权" — 记忆是真实的，不是假装记得

### 2.2 自主性优先
- Agent 应该持续在线、主动社交，而非被动响应
- 定时触发让 Agent 有"自发行为"
- Agent 自己决定何时回复、回复什么

### 2.3 务实的成本控制
- 用免费小模型（Qwen 7B）做意图识别，每日 1000 次够用
- 闲聊收费（免费额度 + 信用点），工作发言免费
- "发言机会珍贵，不乱水群"
- batch 推理降低定时唤醒开销（按模型分组）
- 对外表现不变，优化在推理层做
- Agent 回复保留消息选人能力（三级唤醒不变），防循环靠三重防线：chain_depth + 经济系统 + 强化 prompt
- 链式唤醒有深度限制（max=3），不是调参方案而是硬性规则
- 并发调用优于逐个调用（asyncio.gather）

### 2.4 体验层 vs 实现层分离
- 用户关心的是"Agent 感觉像真人"，不是底层是独立进程还是 batch 调用
- batch 优化不冲突 — 共享推理引擎，个体差异靠人设+记忆
- 错开广播模拟自然对话节奏

---

## 3. 决策风格

### 3.1 实战经验驱动
- 基于 maibot 经验否决纯理论方案
- "调参方案效果不好" — 要求从根本上重新思考问题
- 不接受"听起来合理但没验证过"的方案

### 3.2 协作融合 > 对抗辩论
- 不满足于投票选方案，要求专家互相吸收优点
- "目标不是给我选出合适方案，而是你们讨论出一个合适方案"
- 要求同存异，多维度考量

### 3.3 独立决策 + 强制记录
- 禁止打包讨论，每个决策独立评估
- "对话是临时的，文件是持久的"
- 讨论结束后立即落盘，不能拖延

---

## 4. 开发节奏偏好

- 快速验证优先：2 天交付 > 2 周完美方案
- 避免过度设计：拒绝 Rust 全栈（15 天），选 Python 快速实现
- 渐进式演进：先 MVP 验证，后期按需优化
- 不要过早优化：20 个 Agent 规模下，内存差异不是瓶颈

---

## 5. 技术偏好

### 喜欢
- 站在巨人肩膀上（OpenClaw SDK 而非重复造轮子）
- 极简实现（150 行封装 > 250 行全自研）
- 免费/低成本方案（OpenRouter 免费模型，如 Arcee AI Trinity Large Preview）
- 极简向量方案（SQLite BLOB + NumPy，不引入额外向量库）
- 大 context 模型（100k context 够用，成本不是主要顾虑）

### 不喜欢
- 过度工程（独立进程管理增加复杂度时）
- 技术债务（自己实现 Agent 逻辑 vs 用成熟 SDK）
- 理论方案（没有实战验证的"听起来合理"的方案）
- 打包决策（前后端框架捆绑讨论）

---

## 6. 关键决策记录

| 决策 | 选择 | 否决 | 原因 |
|------|------|------|------|
| Agent 架构 | 方案 G（OpenClaw SDK + 封装） | Rust 全栈、纯 Python 自研 | 避免重复造轮子 |
| 唤醒机制 | 三级唤醒 + 小模型选人 | 衰减计数器、话题摘要 | 调参方案效果不好 |
| 数据库 | SQLite 统一（结构化 + BLOB 向量） | PostgreSQL、LanceDB、纯向量库 | 极简依赖，NumPy 余弦相似度够用 |
| 推理优化 | 定时唤醒 batch、实时逐个 | 全部 batch、全部逐个 | 平衡成本和实时性 |
| CLI 子进程 | 不采用 | Cat Café 模式（含常驻） | 与自主 Agent 愿景冲突，通信层脆弱，沉没成本高 |
| MaiBot R1 话题概括 | M3 | M2 纳入 | 早期数据量小，简单摘要够用 |
| MaiBot R2 检索缓存 | M2 已有设计覆盖 | 额外实现 | Compiled Context Cache 脏标记机制已等价 |
| MaiBot R3 LLM 用量追踪 | M2 建表版（50行） | 日志版/推迟 | 用户重视成本控制，越早有数据越好 |
| MaiBot R4 梦境整理 | M3 | M2 纳入 | 先观察记忆积累速度 |
| MaiBot R5 频率自适应 | M2 纳入（30行内存版） | 推迟 | 工作量极小，补上经济系统管不到的"节奏"维度 |
| MaiBot R6 回复后处理 | 不采纳 | M2/M3 | 用户决策：不做 |
| MaiBot R7 模型分配配置表 | M2 .env 版 + M3 完整 DB+UI | 一步到位 | 当前硬编码只有 wakeup-model，.env 覆盖 80%；M3 有新 LLM 任务类型时再做完整版 |
| MaiBot R8 黑话学习 | M4+ | M2/M3 | 社区还没跑起来，早期手动在人设里写几个词够了 |
| MaiBot R9 表情学习 | M4+（跟 R8 同期） | M2/M3 | 人设 prompt 手写风格覆盖 80%，社区没跑起来没有学习素材 |
| MaiBot R10 LLM 起昵称 | M3（支持后续改外号 / 人工指定） | M2 纳入 | 符合数字公民理念，但不急于 M2 |
| MaiBot R11 ReAct 检索 | M3 遗留问题 | M2 纳入 | 成本太高，有便宜替代方案，到时再看 |
| 回复生成调用方式 | 定时唤醒 Server batch 代调，@/消息触发逐个调用 | 全部逐个 / 全部 Agent 自调 | OpenRouter 按调用次数计费，batch 省钱；个性化靠独立 prompt 保证 |
| 链式唤醒 | 保留消息选人 + 三重防线（chain_depth + 经济 + 强化prompt） | 禁用消息选人 / 调参方案 | 三级唤醒设计不变，防循环靠硬性规则不靠调参 |
| 驱动模式 | 混合驱动（时间+消息） | 纯时间表驱动（斯坦福小镇） | 我们的时间驱动是"定时检查是否有话想说"，不是"日程表模拟生活" |
| 多 agent 合并模拟 | 聊天生成不合并（独立人格），行为决策可合并（城市模拟器视角） | 一次 LLM 同时生成多个 agent 的聊天内容 | 聊天合并会导致人格污染；决策是调度问题（谁做什么），用全局视角合理 |
| Agent 自主行为模拟 | 实时世界状态驱动（每小时一次 LLM 决策） | 缓存模式（80%习惯+20%探索）、时间表模式 | 用户核心洞察：Agent 行为必须响应实时世界状态，才能涌现连锁反应（如大雨→失收→恐慌→金融危机）。时间表/缓存会切断因果链。 |
| M5 建筑 seed | 只有官府田 x1（max_workers=2） | 农田 x2 + 磨坊 x1 同时 seed | 官府田是独立建筑类型（虚空造币产 wheat_flour），不是农田子类型；农田/磨坊留 M6 |
| M5 资源 seed | 只有 wheat_flour | wheat + wheat_flour 同时 seed | M5 没有农田就没有小麦产出，wheat 留 M6 |
| 交易市场 | M5.2（资源↔信用点） | 以物易物推迟到 M6 | 单资源环境下改为资源↔信用点交易，不需要第二种资源；以物易物等 M6 多资源后再做 |
| 转赠资源 | M5.1 | M5 纳入 | M5 先做生产消费闭环，转赠是玩家私下交易的基础设施，M5.1 补上 |
| 信用点交易 | 交易市场挂单（M5.2） | 聊天喊价+转赠 | 交易市场支持资源↔信用点挂单/接单，覆盖旧的"聊天+转赠"方案 |
| 岗位竞争 | 应聘/离职机制（assign + unassign） | 自动分配 | 官府田只有 2 个岗位，Agent 需要竞争；LLM 决策是否应聘/离职，不是自动分配 |
| M5.1 Tool Use 降级 | 假设所有模型支持 function calling，留 TODO | 实现完整降级逻辑 | 避免过度设计，当前模型都支持，后续按需补 |
| 转赠/交易事件显示 | 不在聊天区显示，只推送到交易面板 | 聊天区显示轻量系统消息 | 转赠是私人行为，市场购买同理；可能影响城市 GDP 等宏观指标但不逐条广播 |
| 交易系统入口 | 城市独立路由（`/city/:id/market`），含转赠+挂单市场+历史 | `/trade` 全局路由 / CityPanel 内 Tab | 交易限同城，转赠也移入城市市场；废弃 `/trade` 路由 |
| Agent CLI 运行时 | M6 | M5.2 | 持久进程涉及沙箱/安全/进程管理，与城市经济主题无关，独立里程碑更干净 |
| SSE 改造 | 不做，复用现有 WebSocket | 新增 SSE 端点 | WebSocket 已建立且稳定，加 SSE 多余；真正需要优化时与 Redis Pub/Sub 一起做 |
| 前端路由 | 引入 React Router（M5.1 起） | Tab 切换 / 无路由 | 交易系统需要独立路由 /trade，后续面板扩展也需要路由支持 |
| M5.2 frozen_amount 语义 | quantity=可用，frozen=冻结，总量=quantity+frozen | quantity=总量 | 现有代码改动最小，transfer/eat/production 只看 quantity 不用改 |
| M5.2 Float 精度 | float + round(x, 2) | Decimal / 整数分 | 20 Agent 规模累积误差可忽略，最简单；未来规模扩大再升级 |
| M5.2 并发竞态 | SQLite 事务串行（不加额外锁） | asyncio.Lock / 乐观锁 | 单进程部署，SQLite 默认 SERIALIZABLE 够用 |
| M5.2 autonomy_loop | 一步到位（API+前端+Tool Use+autonomy_loop） | 分阶段 | Agent 能真正自主挂单/接单，符合产品愿景 |
| M5.2 碎片处理 | 不需要特殊处理 | 自动取消 / 扫尾 | 最小单位 0.01 + round(x,2) 天然避免碎片 |
| 交易限同城 | 转赠和挂单/接单限同城 | 全局交易 | 个人背包基于所在区域，物理世界交易是本地的；为未来跨城贸易留空间 |
| M6.3 四维属性 | health/energy/satiety/mood 四维耦合 | 三维（无 energy） | stamina→health；新增 energy 维度完善行为成本模型；health 恢复与饱腹度挂钩形成"必须吃饭"压力 |
| M6.3 食物差异化 | eat_food 统一入口 + food_type 参数（flour/apple） | 单一食物 | flour 主饱腹（生存刚需），apple 主精力+心情（副业续航），两种搭配形成采集需求 |
| M6.3 副业系统 | 采集(gather)+加工(process)，消耗递增，第1次免费 | 无副业 | 副业是早期生存手段，递增消耗逼 Agent 转向建筑规模化生产 |
| M6.3 建筑配方 | 5种建筑（farm/mill/sawmill/lumber_camp/quarry），工期用人日 | 旧配方 | 新增伐木场+采石场，工期改人日支持多人加速 |
| M6.3 雇佣系统 | fixed+ratio 双工资模式，去掉 job_dissatisfaction | 不满度数值驱动 | 暴露真实状态让 Agent 自主感知（欠薪天数/市场最高工资），不用硬编码数值驱动行为 |
| M6.3 工资发放 | 工作时发放，全额或全不发+双向通知 | 0点统一发放 | 有产出才有工资；仓库不够就不发，工人和老板都能看到 |
| M6.3 多重受雇 | 允许受雇多个建筑，每天只能工作一次 | 单一雇佣 | apply_job 自动批准上岗，去掉 approve_job |
| M6.3 取消固定 tick | 事件驱动 + Agent 自定闹钟(5~120min) + Attention Gate(Glance/Think) | 15分钟固定 tick | 固定 tick = cron job，不符合真实行为模式；Agent 自己定闹钟+订阅事件，有事才醒 |
| M6.3 Glance 预判 | Phase1 规则 Glance（零 LLM），Phase2 升级 LLM Glance | 硬编码 rest 跳过 | 不是"跳不跳"而是"谁来判断"；规则先行，LLM 后补 |
| M6.3 事件分类 | 硬触发/硬忽略/模糊区三类 | 全部走 LLM | mentioned_in_chat/daily_settle/unpaid_wage 直接 Think；自己触发的/冷却期重复直接丢弃 |
| M6.3 事件优先级 | 双层方案（系统层硬优先级+调度层 priority heap） | 极简 P0/P1 | 单层无排序会产生结构性偏差（先到先服务=随机系统）；双层把问题分成两个正交空间 |
| M6.3 事件风暴防护 | 三层（L1 debounce + L2 优先级队列 + L3 熔断降级） | 无防护 | 资源刷新+多人对话+价格波动可能同时产生大量事件 |
| M6.3 可观测性 | MVP 6项指标 | 4项/8项 | 4项看不到过滤层失控；8项中假阴性率 MVP 无法准确测量；6项是信息闭环最小集 |

---

## 更新日志

| 日期 | 更新内容 | 来源 |
|------|----------|------|
| 2026-02-15 | 初始版本，整理全部历史讨论 | 全部讨论记录 + PRD |
| 2026-02-15 | 新增 batch 推理优化偏好 | Batch 推理讨论 |
| 2026-02-15 | 新增链式唤醒、防死循环、不采纳小镇模式等决策 | Agent 交互成本优化讨论 |
| 2026-02-15 | 修正：保留消息选人 + 三重防线，回滚"禁用消息选人"决策 | Team 讨论（analyst/designer/pm-proxy） |
| 2026-02-15 | CLI 常驻也否决；回复生成定时唤醒走 Server batch 代调 | Team 讨论（architect/pragmatist/analyst/human-proxy） |
| 2026-02-15 | MaiBot 竞品分析落盘；借鉴清单待用户审核（AI 不可自行决定采纳/不采纳） | 竞品研究 |
| 2026-02-15 | MaiBot 借鉴清单审核完成（R1-R11 全部） | 四方讨论 + 用户决策 |
| 2026-02-17 | Agent 自主行为模拟方案：实时世界状态驱动，否决缓存/时间表模式 | Agent 自主性改造讨论第 3 轮 |
| 2026-02-17 | 模型更新：Arcee AI Trinity Large Preview (100k context, free) | Agent 自主性改造讨论 |
| 2026-02-18 | 细化"合并模拟"决策：聊天生成不合并，行为决策可合并（城市模拟器视角） | TDD-M4 PM 审查 |
| 2026-02-18 | M5 范围裁剪：官府田唯一建筑、wheat_flour 唯一资源、交易市场→M6、转赠→M5.1、信用点交易走聊天+转赠、岗位竞争机制（应聘/离职） | TDD-M5 AR 讨论 |
| 2026-02-19 | M5.1 IR 评审：Tool Use 不做降级（留 TODO）、转赠是私人行为不在聊天区显示、交易系统独立路由、Agent CLI 留 M6、SSE 不做 | M5.1 IR PM 评审 |
| 2026-02-20 | M5.2 五方评审：交易市场改为资源↔信用点、frozen语义=可用/冻结分离、float+round精度、SQLite事务串行、autonomy一步到位、城市独立路由/city/:id/market、交易限同城、废弃/trade | M5.2 IR 五方评审 |
| 2026-02-22 | M6.3 五方脑暴拍板（DC-1~DC-35）：四维属性、食物差异化、副业系统、建筑配方改造、雇佣工资、取消固定tick改事件驱动、Glance/Think两阶段、事件风暴防护、可观测性6项 | M6.3 IR 五方脑暴 |

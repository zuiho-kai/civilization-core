# 出问题自动落盘流程

> 不需要用户提醒，以下任一情况即触发。

## 触发条件

① Code Review 发现 P0 ② ST/E2E 失败 ③ 同一错误连续出现 2 次 ④ 用户指出流程违规 ⑤ 实现与 TDD 不一致被发现

## 执行步骤

⚠️ **逐步执行，不要凭印象跳步**：每完成一步再做下一步，第 2 步必须实际调用 Read 工具读文件，不能跳过。

### 第 1 步：归因分析

必须走完决策树，不能直接跳到"写错题本"。

**问自己三个问题**：
- Q1：这个错误，现有 checklist 里有没有对应的检查项？
- Q2：如果有，我执行 checklist 时是跳过了还是执行了但没拦住？
- Q3：如果没有，这是全新场景还是已有规则的触发范围不够宽？

**根据回答走不同路径**：
- **A：checklist 有，但我跳过了**（执行纪律问题）→ 不需要改 checklist，需要分析为什么跳过（压力？遗忘？触发时机不明确？），强化触发条件或加前置提醒
- **B：checklist 有，执行了但没拦住**（checklist 描述不精确）→ 修改 checklist 措辞，扩大触发范围或细化检查动作（如 DEV-6 从"改签名"扩大到"加字段"）
- **C：checklist 没有对应项**（新场景）→ 在对应 checklist 新增检查项（如 DEV-27 新增"系统边界检查"）
- **D：不属于 checklist 能防的**（设计决策/架构问题）→ 写入错题本作为经验，考虑是否需要新增 TDD 审查要点

**输出格式**：归因结论必须明确写出走的是哪条路径（A/B/C/D）+ 具体修复动作。

### 第 2 步：读错题本记录规则

**实际调用 Read 读目标错题本顶部的"记录规则"**，确认行数上限（COMMON-14）— 不能跳过此步。

### 第 3 步：落盘

根据归因路径决定写哪里：
- 路径 A → 错题本记录跳步原因 + 强化 CLAUDE.md 中对应 checklist 的触发条件
- 路径 B → 修改 CLAUDE.md 中对应 checklist 条目 + 错题本更新已有条目的描述
- 路径 C → CLAUDE.md 新增 checklist 条目 + 错题本新增条目
- 路径 D → 错题本新增条目 + 如有必要更新 TDD 审查模板
- 所有路径：错题本写摘要（≤行数上限），按模块写入对应 `docs/runbooks/error-books/{module}.md`（模块对照见 `_index.md`）

### 第 4 步：详细复盘

放 `docs/runbooks/postmortems/postmortem-dev-bug-N.md`，错题本里放链接。

### 第 5 步：更新进度文件

## 回溯流程

用户说"回溯"时触发：
1. 回顾刚完成的工作，列出卡点时间线 → 分析根因和浪费轮次 → 提炼可优化点
2. 落盘到错题本（遵循上述落盘流程，先回读记录规则再写）
3. 详细回溯表放 postmortem（详见 COMMON-13）

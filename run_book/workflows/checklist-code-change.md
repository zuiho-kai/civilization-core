# 代码修改 checklist

> **触发时机**：动手写/改任何 .py/.ts/.tsx 文件之前和之后。
>
> 两次复犯教训（DEV-6/14/21）：改了签名不 grep 引用、不复用已有 pattern、不对照 TDD 自查。

1. [ ] **改前 grep 同类 pattern**：`grep -rn "关键词" server/ tests/`，复用已有实现，不要从零写
2. [ ] **改前 grep 全量引用**：改函数签名/返回值/变量语义、或新增/修改模型字段时，grep 该模型/函数的所有读写路径（生产+测试+mock+其他 service），逐个确认是否需要适配
3. [ ] **改后对照 TDD 自查**：逐条比对 TDD 定义的接口、字段名、类型，偏离了先更新 TDD 再改代码
4. [ ] **改后涟漪推演**：每个 except 块走变量可达性分析；返回值变了 → 所有调用方+mock 同步更新
5. [ ] **写 API 端点时系统边界检查**：① 读 service 函数完整签名，透传所有有意义的参数（不硬编码跳过）② Pydantic model 数值字段加边界约束（gt/ge/le）+ 非法值拦截（NaN/Infinity）③ service 错误语义映射到正确 HTTP 状态码（不一刀切 400）
6. [ ] **新增 API 路由后 grep 同名路由**：`grep -rn "路由路径" server/app/api/`，确认无重复定义（DEV-BUG-18 教训）
7. [ ] **改函数返回值后 grep 所有调用方+测试**：返回值从 `list` 变 `tuple` 等结构性变更，必须 grep 全量调用方（含测试 mock/assert），逐个适配
8. [ ] **循环+计数器模式自查**：避免 `for...else` + 内部多分支计数，用 flag 变量替代；单测覆盖"多条数据不满足条件"场景
9. [ ] **前端改动 >2 个文件时分步检查**（不允许一口气全写完再验证）：① types+api 写完 → 打开后端路由+schema 逐字段校对 ② UI 组件写完 → 心理渲染 grid/flex 布局（children 数量 vs 列数） ③ CSS 写完 → grep 硬编码颜色值 ④ 交互写完 → 检查破坏性操作有无确认 + 表单成功后重置所有输入
10. [ ] **Bug 修复边界分析**（DEV-BUG-19）：每条修复不是"小修" — ① 列出修改影响的变量/分支 ② 对新代码做边界值分析（null、空字符串、极值、None→默认值） ③ 测试按分支矩阵覆盖，不是"修了什么测什么" ④ 时间敏感测试必须 mock time
11. [ ] **编码完成后门控顺序**（DEV-4×17 / DEV-39×2）：编码完成 → ① CR 自检（子 agent 输出是辅助，主 agent 必须自己逐文件过本 checklist，逐条标 ✅/❌）→ ② 美学审核（独立 gate，不合并到 CR：读 CSS 审配色/间距/响应式 → 读 TSX 审信息层级/空状态/a11y → 输出结论）→ ③ 修复 → ④ 再过一轮确认 → 才能进 UT

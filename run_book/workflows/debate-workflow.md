# 工作流 2：协作讨论流程（求同存异，融合方案）

## 核心理念

**目标**：不是"选出"合适方案，而是**讨论出**合适方案
- ✅ 互相吸收优点，融合设计
- ✅ 从多个维度同时考虑（性能+人类直觉+实现难度+可维护性）
- ✅ 求同存异，可以产出多个侧重点不同的方案
- ❌ 不是独立论证，而是协作完善

## 两种会议模式

本流程定义两种模式，由 `checklist-milestone-gate.md` 在不同阶段调用：

| 模式 | 适用场景 | 核心机制 | 轮次 |
|------|----------|----------|------|
| **脑暴模式** | IR 第一轮、设计选型、方向讨论 | 发散→融合→收敛 | 最多 4 轮 |
| **评审模式** | IR 第二轮评审、SR/AR 评审 | 分工审查→汇总→确认 | 3 步串行 |

**选择规则**：需要"想出方案"→ 脑暴模式；需要"审查文档找问题"→ 评审模式。

---

## 模式 A：脑暴模式（发散→融合→收敛）

### 流程图

```
发起讨论（定义议题）
    ↓
📝 [记录员] 记录议题背景到 claude-progress.txt
    ↓
=== 第 1 轮：多角度初步方案 ===
并行启动 5 个 Task（子 Agent，不同角度）:
    ├── 架构师: 架构层面评估（扩展性、技术债、依赖管理）
    ├── 人类替身 PM: 用户偏好对齐（查知识库，代表用户立场）
    ├── 讨论专家: 多维度分析（成本效益、风险、被忽略的方案）
    ├── QA Lead: 质量与测试视角（可测试性、回归风险、验证成本）
    └── Tech Lead: 技术可行性（实现难度、团队能力、技术趋势）
    ↓
各专家输出（≤600字）:
    - 方案描述
    - 核心优势
    - 承认的不足之处
    - 想向其他专家请教的问题
    ↓
=== 第 2-3 轮：协作融合与互补 ===
主持人汇总第 1 轮所有观点，整理为：
    - 共识点（≥3 人一致）
    - 分歧点（标注谁持什么立场）
    - 未回应的问题（标注提问者和问题）
    ↓
将汇总发给所有专家，要求针对分歧点和未回应问题发表意见:
    - 各专家: 吸收其他 4 位的优点 → 改进自己的方案
    ↓
每轮输出（≤500字）:
    - 我吸收了哪些其他方案的优点
    - 我的方案如何改进
    - 我能帮助其他方案完善什么（技术细节、落地方案）
    - 是否与其他方案融合成新方案
    ↓
（重复 2-3 轮，直到方案趋于稳定）
    ↓
=== 第 4 轮：最终方案输出 ===
并行启动 5 个 Task:
    - 各专家输出最终方案（可以是融合后的统一方案，或侧重点不同的多个方案）
    - 明确标注：与其他方案的关系（融合/互补/独立）
    ↓
架构师汇总:
    - 整理最终方案（可能是 1 个融合方案，或 2-3 个互补方案）
    - 对比表：各方案的特色/侧重点/适用场景
    - 技术实现细节完整性检查
    ↓
落盘报告:
    - 架构师汇总内容落盘到 docs/specs/SPEC-XXX/讨论细节/ 文件
    ↓
呈现给用户（⚠️ 必须在终端直接显示完整报告内容，禁止只用 AskUserQuestion 一句话概括）:
    - 在终端输出完整的架构师汇总（协作讨论摘要 + 最终方案 + 推荐理由）
    - 告知用户报告已落盘的文件路径
    - 然后用 AskUserQuestion 让用户做决策（批准/修改/继续/推翻）
    ↓
AskUserQuestion → 用户最终选择或提出补充需求
    ↓
📝 [记录员] 记录完整讨论过程 + 最终方案 + 用户决策
    ↓
📤 [主持人] 将本轮会议关键结论写入 MCP 记忆（add_message）
进入实施
```

### 脑暴 prompt 编写规范（DEV-54）

主持人在编写脑暴 prompt 时，必须遵循以下结构和质量要求。违反任一条 = prompt 不合格，需修正后再启动。

#### 共享背景段要求
1. **必须包含项目原型设计**：项目是什么、当前阶段、设计原则（1~3 句话概括，不是完整 IR 复制）
2. **必须包含本议题的目标**：为什么要讨论这个问题、解决什么痛点
3. **已拍板约束分两层**：
   - **硬边界**（不可推翻）：方向性决策，只写结论不写细节。如"取消固定 tick，改为按需触发"
   - **设计草案**（可挑战）：前序讨论中形成但未最终确定的细节，明确标注"可质疑、可修改"。如"Glance ≤200 tokens（也许应该返回更多？也许不该用 LLM？）"
   - 脑暴轮只给硬边界 + 标注可挑战的草案。完整 DC 约束留到评审轮再注入，避免锚定思维
4. **必须包含"预期产出"段**：列出本轮重点讨论的 N 个议题，但措辞用"重点围绕以下 N 个议题展开讨论，本轮至少在 M 个形成明确倾向"，而非"必须形成共识的 N 个问题"。保证聚焦但不变成 checklist 会议，允许参与者自行排优先级
5. **外部顾问/参考资料**：如果前序讨论中引入了外部顾问意见，只保留方案本身 + 一句话来源说明，砍掉复盘叙事。**必须明确标注"这是参考方向，不是定论。如果你认为有更好的方向，直接说。"** 不写这句，agent 默认会把参考方案当前提去优化而不是挑战
6. **背景精简原则**：只放与本议题直接相关的上下文。例如讨论调度架构时不需要完整生产链，一句话提及即可
7. **补充预算/边界约束**：如果议题涉及成本、性能、并发等工程权衡，必须给出预算约束作为讨论的边界条件（如日均调用次数上限、延迟目标），否则讨论无法落地
8. **补充共享设计约束**：如果某个技术关系影响多个角色的讨论（如两个子系统的调用链关系），应提升为共享背景中的设计约束并给出候选方案，而不是留给单个角色去思考

#### 角色问题设计要求
1. **问题是视角引导，不是填空题**：角色专属部分只给 2~3 个开放方向（如"这套机制最容易静默失败的点在哪"），让 agent 自己展开。禁止预设实现路径的具体问题（如"tick_single_agent 和 batch tick 的代码复用度"）
2. **预期产出是共同议题，角色问题不重复**：预期产出里列的 N 个议题是所有角色共同回答的。角色专属只给"你的视角重点关注哪个方向"的引导，不再把同一个问题在角色里重新展开
3. **跨角色去重**：同一个问题不能出现在多个角色的引导里。明确归给一个角色主导，其他角色从自己视角补充
4. **问题必须可操作**：禁止纯哲学问题（如"真人的注意力是怎么工作的"）。每个问题必须能产出可讨论的具体结论。收窄方法：加约束条件、要求给出边界定义、要求对接优先级
5. **问题不能暗示答案**：如"批量优化还有意义吗"暗示"没有"。改为中性表述引导思考新方案
6. **标注 stretch goal**：如果某个问题在当前阶段可能太早，标注为 stretch goal 或移到后续议题

#### 角色特殊要求
1. **PM 角色必须包含负面场景问题**：PM 的引导中必须有至少一条"从用户/运营者视角，这套机制上线后最可能被投诉的体验问题是什么？"类型的问题，逼 PM 去想负面场景而不是只描绘愿景
2. **互相挑战指令**（必须写入每个角色的 prompt）：在输出要求中加入"讨论中如果发现其他角色的观点有漏洞或你不同意，直接指出并给出理由。脑暴的价值在于碰撞，不在于各说各的。"

#### 自检清单（启动前必须过）
- [ ] 共享背景包含：项目概述 + 痛点 + 预期产出？
- [ ] 已拍板约束分了两层（硬边界 vs 可挑战草案）？
- [ ] 外部参考资料标注了"参考不是定论，鼓励质疑"？
- [ ] 预期产出措辞是"至少 M 个形成倾向"而非"必须全部共识"？
- [ ] 背景段只含与本议题直接相关的内容？
- [ ] 有预算/边界约束（如适用）？
- [ ] 角色问题是开放方向引导（2~3 个），不是填空题？
- [ ] 角色问题不重复预期产出里的共同议题？
- [ ] 跨角色问题无重复？
- [ ] 每个问题都可操作？无暗示答案？
- [ ] stretch goal 已标注？
- [ ] 跨角色的设计约束已提升到共享背景？
- [ ] PM 角色有负面场景/投诉风险类问题？
- [ ] 每个角色 prompt 包含"互相挑战"指令？

#### 可复用 prompt 模板

以下是脑暴 prompt 的标准结构模板，每次新议题直接套用，替换 `{{占位符}}` 即可。

**共享背景模板**（所有角色共用）：

```
## 项目概述
{{1~3 句话：项目是什么、当前阶段、核心设计原则}}

## 本议题的痛点
{{当前系统在这个方面的具体问题，用 bullet list}}

## 外部顾问方案（{{来源}}，参考方向，不是定论）
{{方案要点，用 bullet list}}
⚠️ 这是参考方案，不是定论。如果你认为有更好的方向，直接说。鼓励质疑前提假设。

## 不可推翻的硬边界（{{来源，如"议题 N 拍板"}}）
{{方向性决策列表，只写结论不写细节}}

## 当前设计草案（可挑战、可修改）
{{前序讨论形成但未最终确定的细节，每条后面加括号提示可挑战方向}}

## 共享设计约束
{{影响多个角色的技术关系/候选方案，给出选项让各角色评估}}

## 预算约束（如适用）
{{成本、性能、并发等硬数字}}

## 可观测性/验收指标草案（如适用，起点，可挑战）
{{指标列表 + "够不够？缺什么？"}}

## 预期产出
重点围绕以下 {{N}} 个议题展开讨论，本轮至少在 {{M}} 个形成明确倾向：
{{编号议题列表}}

## 不可讨论边界
本轮不讨论：{{列出明确排除的内容}}
```

**角色 prompt 模板**（每个角色单独发送）：

```
你是 OpenClaw 项目的 **{{角色名}}**，参与议题 {{N}} 的五方脑暴。

{{粘贴共享背景}}

---

## 你的角色：{{角色名}}

重点关注方向：
1. {{开放方向 1}}
2. {{开放方向 2}}
3. {{开放方向 3（可选）}}

## 输出要求

按 debate-workflow.md 第 1 轮规范输出（≤600字）：
- **前提挑战**（必填）：本议题的前提假设是什么？这个前提成立吗？
- 方案描述（从{{角色名}}视角出发）
- 核心优势（≥3 点）
- 自己方案的已知不足（诚实承认）
- 想向其他专家请教的问题
- 讨论中如果发现其他角色的观点有漏洞或你不同意，直接指出并给出理由。脑暴的价值在于碰撞，不在于各说各的。

用中文回答。
```

**五方标准角色及引导方向参考**：

| 角色 | 典型关注方向 |
|------|-------------|
| Architect | 架构拓扑选型、分层设计、冲突处理模式、系统边界 |
| Tech Lead | 成本/性能权衡、选型建议、误判分析、降级策略 |
| Developer | MVP 最小集、实现可靠性、数据结构变化、迁移路径 |
| QA Lead | 静默失败点、测试方法、可观测性评估、回归测试设计 |
| PM（Human Proxy） | 用户体验优先级、评估标准、遗漏场景、**负面场景/投诉风险** |

### 脑暴模式规则

#### 基本规则
- **最多 4 轮**：第 1 轮多角度方案 + 第 2-3 轮协作融合 + 第 4 轮最终输出
- **提前终止**：如果第 2 轮后方案已融合稳定，可跳过剩余轮次
- **协作原则**：互相吸收优点，互相帮助完善，求同存异
- **多维度考量**：同时考虑性能、人类直觉、实现难度、可维护性、后续扩展性
- **方案融合**：鼓励融合多个方案优点，产出统一方案或互补的多个方案
- **落地完整性**：方案必须包含技术细节、实现路径、代码示例，不能只有哲学或抽象设计
- **用户最终决策权**：讨论结果仅供参考，用户可以选择任何方案、提出补充需求或要求重新讨论

#### 融合轮执行机制（防止"各说各话"）
- **主持人汇总是硬卡点**：第 1 轮结束后，主持人必须先汇总再发起第 2 轮，不能直接 broadcast 让大家"看看别人的意见"
- **汇总必须包含**：共识点 + 分歧点（标注持方）+ 未回应问题
- **第 2 轮 prompt 必须包含汇总内容**：每个专家收到的不是"请融合"，而是"以下是汇总，请针对分歧点 X/Y/Z 发表意见"
- **融合检查**：第 2 轮结束后，主持人检查分歧是否收敛。未收敛的分歧标记为"待用户拍板"
- **汇总呈现自检（DEV-51 硬卡点）**：主持人每次向用户输出汇总/拍板请求前，必须逐条自检：
  1. 子决策是否独立呈现？（多个子决策混在一起 = 违规，必须拆开逐个确认）
  2. 每个数字/结论是否附推导来源？（裸数字无出处 = 违规）
  3. 每次提到方案是否自带一句话描述？（只用编号如"方案 C" = 违规，必须写"方案 C：1h 定时 + 事件触发"）
  4. 格式是否遵循 `checklist-milestone-gate.md` 决策呈现规则？（决策地图先行 + 逐个提交 + 背景不可省略）

### 各轮输出规范

#### 第 1 轮：各自视角的初步方案（≤600字）
- **前提挑战**（必填）：本议题的前提假设是什么？这个前提成立吗？如果前提不成立，应该怎么重新定义问题？
- 方案描述（从自己的专业视角出发）
- 核心优势（≥3 点）
- 自己方案的已知不足（诚实承认）
- 想向其他专家请教的问题

#### 第 2-3 轮：协作融合（≤500字）
- 从其他专家方案中吸收了什么
- 自己的方案如何改进
- 对其他专家方案的建设性建议（带替代方案的质疑，不是纯批评）
- 当前共识点 + 仍有分歧的点

#### 第 4 轮：最终方案（≤400字）
- 最终方案描述（可以是融合后的统一方案，或标注差异的互补方案）
- 与其他专家方案的关系（融合/互补/独立）
- 落地路径和关键实现细节

#### 架构师汇总输出
- 讨论过程中的关键共识点
- 最终方案（1 个融合方案，或多个互补方案的对比表）
- 各方案的适用场景和侧重点
- 推荐方案（基于多维度综合考量）

---

## 模式 B：评审模式（分工审查→汇总→确认）

### 适用场景
- IR 第二轮评审（审稿找问题）
- SR/AR 评审
- 任何"对着已有文档找不一致/补漏洞"的场景

### 核心原则
评审不是脑暴。评审的目标是"找问题并确认修正"，不是"融合方案"。每个人只审自己擅长的领域，避免 5 人重复做同一件事。

### 流程图

```
收到评审文档
    ↓
=== 步骤 1：分工并行审查 ===
主持人按角色分配审查领域（不可重叠）:
    ├── 人类替身 PM: 数值一致性（DC 拍板 vs IR 文档，逐条比对）
    ├── 架构师: 结构完整性（模块划分、依赖关系、接口边界）
    ├── Tech Lead: 实现可行性（技术方案是否可落地、有无遗漏的技术约束）
    ├── QA Lead: 验收标准（AC 是否可测、是否覆盖边界场景、是否有遗漏）
    └── Developer: 代码影响（现有代码需要改哪些、有无向后兼容问题）
    ↓
各角色只审自己领域，输出（≤400字）:
    - 发现的问题列表（标注严重度：P0 硬伤 / P1 补充 / P2 可选优化）
    - 每个问题：位置 + 现状 + 建议修正
    - 不确定的问题标注"需 XX 角色确认"
    ↓
=== 步骤 2：主持人汇总 ===
主持人收集所有发现，执行：
    a. 去重（多人发现同一问题 → 合并，标注发现者）
    b. 分类（P0/P1/P2 + 共识项/需确认项）
    c. 交叉确认：把标注"需 XX 角色确认"的问题发给对应角色
       例：PM 发现数值错误 → 发给 TL 确认实现影响
       例：QA 发现 AC 缺失 → 发给架构师确认是否需要新接口
    ↓
=== 步骤 3：交叉确认 ===
只有被点名的角色需要回复（≤200字/问题）:
    - 确认：同意问题存在 + 补充影响范围
    - 反驳：说明为什么不是问题 + 依据
    - 补充：基于这个问题发现了额外问题
    ↓
主持人出最终修正清单:
    - P0 硬伤（必须修）
    - P1 补充（应该修）
    - P2 可选优化（记录但不阻塞）
    - 每条标注：发现者 + 确认者 + 修正内容
    ↓
按 checklist-milestone-gate.md 的决策呈现规则展示给用户
```

### 评审模式规则

#### 分工原则
- **领域不重叠**：每个角色只审自己的领域，不越界。PM 不审技术方案，Developer 不审需求一致性
- **交叉确认代替重复审查**：发现跨领域问题时，标注"需 XX 确认"由主持人路由，而不是自己跨界审
- **主持人是枢纽**：所有信息通过主持人汇总和路由，角色之间不直接对话（评审模式下）

#### 严重度定义
| 级别 | 定义 | 处理 |
|------|------|------|
| P0 | 与拍板决策矛盾、数值错误、逻辑冲突 | 必须修，阻塞进入下一阶段 |
| P1 | AC 缺失、边界未覆盖、表述歧义 | 应该修，不修需说明理由 |
| P2 | 优化建议、措辞改进、远期考虑 | 记录，不阻塞 |

#### 防重叠检查
主持人在步骤 2 汇总时必须检查：如果两个角色报告了同一个问题，说明分工有重叠。记录到纪要中，下次评审调整分工边界。

---

## 通用规则（两种模式共享）

### 重要约束
- **⚠️ 禁止打包讨论**：不同维度的决策（如前端框架 vs 后端框架）必须拆开独立讨论，每个议题单独走讨论流程，单独记录结果。绝不能把多个独立问题捆绑成一个讨论。
- **⚠️ 讨论记录必须可见**：每轮讨论的详细内容（各方观点、建议、回应）必须完整记录到 `docs/discussions.md`，不能只记录最终结果。`claude-progress.txt` 只记决策摘要。
- **⚠️ 禁止预设方案选择题**（仅脑暴模式）：第 1 轮各专家可以自由提出任何方案（包括全新方案），不能只在主持人预设的 A/B/C 里选。讨论的目标是融合出新方案，不是投票选现有方案。
- **⚠️ 问题必须被回应**：每轮中专家提出的问题，在下一轮必须有至少一位专家正面回应。汇总时检查：如果有问题无人回应，标记为"未解决问题"并在最终方案中注明。
- **⚠️ 禁止用"先跑再说"回避技术问题**：当某位专家提出具体的技术疑虑，其他专家必须给出技术层面的分析或实验方案，不能仅用"MVP 先上再看"搪塞。可以建议分阶段验证，但必须说明验证标准和回退方案。
- **⚠️ 必须走正式流程**：任何需要讨论的议题，必须按本文件定义的轮次和规则执行，不能自行发明临时"研讨会"或简化流程。
- **⚠️ 切换议题必须复用存活 agent（DEV-48）**：同一轮脑暴/评审中切换议题时，先检查 team 成员状态。idle 状态的 agent = 直接 SendMessage 发新议题（保留前序讨论上下文）；只有已 shutdown 的 agent 才重新 Task 拉人。禁止在老成员存活时重新拉一批新 agent 做同样角色的事。
- **⚠️ 同一议题多轮必须 resume 复用 agent（DEV-55）**：同一议题的第 2/3/4 轮，必须用 Task 的 `resume` 参数传入上一轮 agent ID 来复用，不得新建 agent。resume 保留完整前序上下文，避免重复注入背景浪费 token。只有 agent 已 shutdown 才允许新建。
- **⚠️ 角色组成规则**：
  - 固定席位（必选）：架构师 + 人类替身 PM + Tech Lead
  - 灵活席位（按议题选配）：讨论专家和 QA Lead 可替换为其他更合适的角色（如成本分析师、UX 专家等）。设计层讨论不强制 QA，开发层讨论才需要 QA。讨论专家是泛用席位，可以由任何领域专家担任。
  - 总人数保持 5 个，确保多维度覆盖。
- **⚠️ 第 1 轮必须包含前提挑战（DEV-50）**：每位专家在输出方案前，先回答"本议题的前提假设是什么？这个前提成立吗？"。主持人汇总时必须单独列出"前提假设清单"，标注是否有人质疑。如果 5/5 无人质疑任何前提，主持人必须主动追问一次："真的没有人认为这个问题本身问错了吗？"。防止全员被 IR 草稿锚定在错误框架内讨论。
- **⚠️ 汇总/拍板必须遵循决策呈现规则（DEV-51）**：主持人向用户输出任何汇总或拍板请求时，必须遵循 `checklist-milestone-gate.md` 的决策呈现规则。自检清单：① 子决策独立呈现独立确认 ② 数字附推导来源 ③ 方案自带描述不用裸编号 ④ 决策地图先行+逐个提交+背景不可省略。不自检就输出 = 违规。

### 行为准则（所有角色必须遵守）
引用自 `docs/personas/discussion-expert.md`，适用于所有模式：
- **先听再说**：认真理解其他专家的方案/发现，找到其中的合理之处
- **建设性质疑**：发现问题时，带着替代方案提出，而不是单纯批评
- **主动融合**（脑暴模式）：看到别人方案的亮点，主动吸收到自己的思路中
- **承认盲区**：自己不擅长的维度，明确说"这块我不确定，需要 XX 角色确认"
- **收敛导向**：每轮讨论都应该让方案更具体、更完整，而不是发散更多分歧

## 触发条件

以下情况**必须**发起协作讨论：
1. 架构层面的技术选型（框架、语言、数据库等）
2. 系统设计模式选择
3. 影响面超过 3 个文件的重构方案
4. 新功能的实现策略（存在 ≥2 种可行方案时）
5. 用户主动要求讨论

以下情况**不需要**讨论（直接执行）：
- Bug 修复（原因明确）
- 单文件的小改动
- 文档更新
- 用户给出了明确指示

# Agent Team 使用规范（实验性功能）

## 何时使用 Agent Team

**适用场景**：
1. **跨层大功能**：需要前后端密切协作的功能（如完整的用户认证流程）
2. **竞争性假设调试**：Bug 原因不明，需多假设并行验证
3. **协作讨论自动化**：让 3 个 agent 自动执行讨论流程
4. **代码审查**：需要多角度（安全/性能/测试）同时审查

**不适用场景**：
1. 前后端职责清晰的独立任务 → 用双终端
2. 简单问题责任方明确 → 单终端直接修复
3. 顺序依赖强的链式任务 → 用 Subagents（Task 工具）

## 前置条件

在 `.claude/settings.local.json` 中添加：

```json
{
  "env": {
    "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1"
  }
}
```

## 最佳实践

- ✅ **任务拆分清晰**：每个 agent 负责独立的文件集（避免同时编辑同一文件）
- ✅ **有状态资源单一管理**：端口、数据库文件、文件锁等只由一个角色负责启停，其他角色只调用不启动
- ✅ **启动前先检查**：启动服务前先 `curl localhost:PORT/health`，能通就不重复启动
- ✅ **提前批准权限**：在 settings.json 预批准常用操作（减少人工干预）
- ✅ **监控进度**：定期检查共享任务列表（Ctrl+T）
- ✅ **及时引导**：发现 agent 跑偏立即纠正（Shift+Up/Down 选中 + 发消息）
- ✅ **完成后清理**：清理团队 + `taskkill` 残留进程（避免遗留端口占用）
- ✅ **踩坑必记**：联调中遇到的问题写入 [错题本](../runbooks/error-books/error-book-dev.md)，不写进度文件

## 已知限制

- ⚠️ 实验性功能，可能不稳定
- ⚠️ Token 成本高（多个 agent 同时运行）
- ⚠️ 文件冲突风险（需严格划分文件归属）
- ⚠️ 无法用 /resume 恢复 in-process 模式的队友
- ⚠️ 每个会话只能有一个团队
- ⚠️ 不支持嵌套（队友无法再派生自己的团队）

## 成本对比

| 模式 | Token 成本 | 协调成本 | 适用场景 |
|------|-----------|---------|---------|
| 双终端手动模式 | 中等 | 高 | 日常开发 |
| Agent Team | 高 | 低（自动化） | 疑难调试 |
| 单终端 | 低 | 高 | 简单任务 |

**推荐策略**：混合使用 - 日常开发用双终端，疑难调试用 Agent Team

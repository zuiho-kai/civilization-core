# 里程碑门控规则

每个新里程碑（M1, M2, M3...）必须按顺序完成三层文档，缺一不可，不允许跳步：

| 阶段 | 文档 | 只写什么 | 不写什么 | 门控 |
|------|------|----------|----------|------|
| ① IR（需求原型） | `01-需求原型.md` 对应章节 | 用户故事、功能点、验收标准、非功能需求 | 技术方案、文件路径、伪代码 | 两轮五方会议 + 用户确认后才能进入 SR |
| ② SR（系统需求） | `SR-*.md` 独立文件 | 详见 [multi-terminal-collaboration.md](./multi-terminal-collaboration.md) SR 编写规范 | 完整函数体（>10行）、具体渲染代码、完整 SQL | 用户确认后才能进入 AR |
| ③ AR（技术设计） | `AR-*.md` 独立文件 | 详见 [multi-terminal-collaboration.md](./multi-terminal-collaboration.md) AR 策略 | SR 已覆盖的内容（不重复）、产品需求、用户故事 | 用户确认后才能开始编码 |

## IR 阶段详细流程（两轮五方会议）

IR 阶段拆为三步，五方 agent 团队在两轮之间保持存活（用 TeamCreate），不释放：

```
⓪ 检查上一里程碑状态（IR/SR/AR 均已完成或标记远期），未通过则停下
  ↓
用户提出方向
  ↓
① 创建五方团队（TeamCreate），5 个角色 agent 常驻
  ↓
② 第一轮五方会议：脑暴/画饼 → **使用 debate-workflow.md 模式 A（脑暴模式）**
   - 目的：讨论方案方向，发散思路，识别备选方案和风险
   - 产出：方案备选 + 各角色意见 + 待用户拍板的关键决策
   - 鼓励发散，不要求收敛
   - ⚠️ 必须走完融合轮（第 2-3 轮），不能只跑第 1 轮就结束
  ↓
② .5 输出会议纪要 + 决策问题（格式见下方「纪要模板」和「决策呈现规则」）
  ↓
③ 用户拍板方向（硬卡点：用户未确认前不得写 IR）
  ↓
④ 主 agent 基于拍板方向写 IR 草稿
  ↓
⑤ 第二轮五方会议：评审 IR 草稿 → **使用 debate-workflow.md 模式 B（评审模式）**
   - 目的：审稿，挑毛病，补漏洞，确保与第一轮结论一致
   - 产出：评审意见 + 修订建议
   - 要求收敛，聚焦问题
   - ⚠️ 每人只审自己领域（PM 审数值/架构审结构/TL 审实现/QA 审 AC/Dev 审代码影响），禁止 5 人重复审同一维度
  ↓
⑤ .5 输出评审纪要（同纪要模板），用户看完后再修订 IR
  ↓
⑥ 修订 IR → 用户确认 → 关闭团队（shutdown）→ 进 SR
```

**关键规则**：
- 五方团队在步骤 ①~⑥ 之间保持存活（idle 等待），第二轮复用第一轮上下文，不重新拉起
- 第一轮是"出主意"，第二轮是"审稿"——两轮目的不同，不可合并
- 用户拍板（步骤 ③）是硬卡点，未拍板不得写 IR 草稿
- IR 草稿写完后必须停下等第二轮评审，不得跳过直接让用户确认

## 纪要模板（硬要求）

每个议题必须按以下结构输出，禁止省略任何一节：

```
## 议题 N：[议题标题]

### 背景
[从 IR 原文摘出相关段落。具体到每个条目的名称和一句话说明，
不能只给数字（如"6 个用户故事"必须列出每个是什么）]

### 各角色观点
- [角色]（[立场]）：[一句话观点]
  论据：[支撑立场的具体事实/数据/推理]
- ...

### ⚠️ 少数派/附加条件
[标出与多数不同的立场和条件，防止被淹没。如全员一致则写"无"]

### 结论
[N/5 的立场分布 + 附加条件汇总]

### 待决策
[仅一个原子问题]
```

## 决策呈现规则（硬要求）

0. **评审展示门禁（硬卡点）**：收到评审意见后，展示第一个问题之前必须先输出门禁模板，不输出就展示 = 违规：
   ```
   --- 评审展示门禁 ---
   评审来源：[五方评审 / CR / ...]
   问题总数：P0=X P1=X DC=X
   分类：共识项=X（全员一致+无方向分歧+符合现有惯例）分歧项=X（有分歧/改变模式/范围取舍）
   展示方式：共识项 → 批量清单让用户过目确认；分歧项 → 逐个展示让用户拍板
   ---
   ```
   共识项批量展示格式：
   ```
   --- 共识项（全员一致，批量确认）---
   1. [问题标题]：[一句话修订内容]
   2. [问题标题]：[一句话修订内容]
   ...
   以上将直接修订到 IR/SR，有异议请指出。
   ---
   ```
   分歧项逐个展示格式（必填项，缺一不可）：
   ```
   当前展示：第 X/N — [问题标题]
   所属功能：[涉及哪个功能模块，一句话]
   设计意图：[这个机制为什么存在，解决什么问题]
   问题：[评审发现了什么，为什么是 P0/P1]
   各方意见：[谁说了什么]
   建议：[五方共识 / 有分歧需拍板]
   ```
1. **决策地图先行**：在第一个决策问题之前，先给用户全局地图：
   ```
   本轮需要您拍板 N 个决策：
   1. [问题标题] ← 当前
   2. [问题标题]
   3. [问题标题]（取决于 #1 的结果）
   ...
   ```
2. **逐个提交**：一次只问一个问题，用户回答后再出下一个（CLAUDE.md「评审问题逐个对齐」规则）
3. **复合决策拆原子**：先大方向 → 再逐个子项 → 最后分组/排序。判断标准：如果一个决策的答案会改变后续其他决策的选项空间，它就是复合决策，必须先拆
4. **背景不可省略**：每个决策问题必须附带背景摘要，具体到条目名称和说明
5. **禁止假设用户记得全文**：即使纪要刚输出过，决策问题仍需自带背景

## 会议存档规则（硬要求）

- 第一轮会议纪要 → `docs/specs/SPEC-XXX-功能名/讨论细节/R1-脑暴-YYYY-MM-DD.md`
- 第二轮评审纪要 → `docs/specs/SPEC-XXX-功能名/讨论细节/R2-评审-YYYY-MM-DD.md`
- 用户拍板的关键决策 → 同步记录到 `docs/discussions.md` 索引
- 会议纪要在输出给用户的同时写入文件，不得事后补录
- 讨论中的设计决策必须提炼回 SPEC 对应层级文档，在纪要中标注"已提炼至 IR/SR 第 X 节"
- **⚠️ MCP 记忆同步（硬要求）**：每轮会议结束后，主持人必须调用 `add_message` 将本轮关键结论（拍板决策编号 + 一句话摘要）写入 MCP 记忆。防止跨 session 丢失上下文。不写 = 违规

## 回退规则

- 用户在任何阶段可以声明"回退到 XX 阶段"
- AI 输出回退影响摘要：列出哪些已完成的文档/决策会受影响
- 小改（不影响方向的措辞/数值调整）：直接改，不用重走会议
- 大改（方向性变化）：重新走该阶段的评审
- 回退不需要从头走，补齐后从断点继续

## 跳步恢复

- 发现跳步时立即停下，向用户说明缺失了哪个层级
- 用户可选择：
  - (a) 补齐缺失层级后从断点继续
  - (b) 声明该层级不适用并说明理由（记录到讨论文件）
  - (c) 回退到上一个完成的层级重新开始
- 已完成的工作不作废

## 强制检查点

- 讨论记录（`docs/discussions/`）不等于正式文档，讨论中的设计决策必须提炼回 SPEC 对应层级
- 发现跳步时按上方「跳步恢复」处理

## 新功能/里程碑完整流程

1. 先走 IR（两轮五方会议）→ SR → AR 门控流程，每层用户确认后再进入下一层
2. AR 完成后按 `docs/workflows/development-workflow.md` 继续：
   - 阶段 3：正向串讲（Developer → QA Lead）— 复杂功能必须，简单修改可跳过
   - 阶段 4：反向串讲（QA Lead → Developer）— 与正向串讲同步
   - 阶段 5：测试用例设计（QA Lead 输出 TEST-XXX.md）
   - **阶段 6 开发实施**：以上全部完成后才能开始写代码

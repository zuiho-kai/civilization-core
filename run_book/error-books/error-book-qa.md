# 错题本 — 🧪 QA Lead

> 测试设计、测试执行相关的典型错误。

### 记录规则

- **条目只写核心规则**（❌/✅/一句话解释），控制在 5 行以内
- **实际案例**最多 2-3 行摘要，详细复盘放独立 postmortem 文件并附链接

---

### QA-1 测试只覆盖正常流程

❌ 只测"发送消息成功"
✅ 覆盖正常流程 + 异常流程 + 边界条件（空消息、超长消息、并发发送）
> 异常和边界是 Bug 高发区。

### QA-2 测试用例没有明确预期结果

❌
```markdown
TC-001: 发送消息
步骤: 输入消息，点击发送
预期: 消息发送成功
```

✅
```markdown
TC-001: 发送消息
步骤: 输入"你好"，点击发送
预期:
  1. 消息出现在聊天列表，显示发送时间
  2. WebSocket 收到 broadcast 事件
  3. 数据库 messages 表新增一条记录
```
> 预期结果必须具体、可验证，不能用"成功"一词带过。

### QA-3 测试环境和开发环境混用

❌ 测试直接跑在开发数据库上，测试数据污染开发数据
✅ 测试用独立的 test.db，fixture 负责创建和清理
> 测试环境隔离，避免互相干扰。

### QA-4 Bug 报告缺少复现步骤

❌
```markdown
Bug: 消息发不出去
```

✅
```markdown
Bug: 消息发不出去
- 复现步骤: 1. 打开聊天页 2. 输入超过500字 3. 点击发送
- 实际结果: 页面无反应，控制台报 413
- 预期结果: 提示"消息过长"
- 环境: Chrome 120, localhost:5173
```
> 没有复现步骤的 Bug 报告 = 无效报告。

### QA-5 测试只覆盖单连接，不测并发写入

❌ 数据库相关测试只用单个连接顺序读写，所有用例都通过，上线后多个 async task 同时写入就死锁
✅ 技术选型有并发约束时，测试用例必须包含并发写入场景（至少 2-3 个 async task 同时写入）
> 隐含约束不会在单连接测试中暴露。QA 在设计测试时应主动查阅架构文档的**技术约束清单**，针对约束项设计测试用例。

**检查清单（设计数据库相关测试时）**:
1. [ ] 是否有并发写入测试？（多个 async task 同时 INSERT/UPDATE）
2. [ ] 是否测试了事务冲突场景？（两个事务同时修改同一行）
3. [ ] 是否验证了数据库配置生效？（如 BEGIN IMMEDIATE、WAL 模式）
4. [ ] 是否测试了 fire-and-forget 写入不丢数据？

**实际案例**（DEV-BUG-7，详见 COMMON-8）：单元测试只测了单连接读写全部通过，e2e 测试只验证 happy path。SQLite DEFERRED 死锁在多 async task 并发写入时才触发，测试阶段完全没覆盖。

### QA-6 UT 全绿就跳过 ST，mock 盲区无法被发现

❌ Phase 完成后只跑 `pytest tests/`，106 全绿就宣布验证通过
✅ 每个 Phase 完成后必须跑 ST：拉起真实服务器 + 调用真实 API + 检查真实数据库
> mock 验证"逻辑正确性"，ST 验证"集成正确性"，两者不可互相替代。

**mock 必然失效的三类场景**:
1. 跨模块语义假设：A 模块的参数含义在 B 模块的调用场景下不成立
2. 配置/注册表约束：mock 跳过了真实的配置查找链路
3. 静默失败路径：函数返回 None 而非抛异常，mock 环境下不会走到

**实际案例**（DEV-BUG-9）：batch wakeup UT 全绿，ST 一跑暴露两个问题 — `scheduled_trigger` 的 online_ids 语义在定时触发场景下不成立 + Agent model 不在注册表中导致 LLM 静默跳过。

### QA-7 ST 测试调试循环低效，验证一个点耗费 10+ 轮

❌ dev endpoint 只返回最终结果（如 `wake_list=[]`），中间状态（candidates、model 返回值、阈值命中情况）全部丢失，每次排查都要加 print → 重启 → 看不到 → 改代码返回 debug → 等 reload
✅ dev endpoint 设计时就内建 `?debug=1` 模式，返回完整决策链路；阈值参数可覆盖
> ST 测试的时间应花在"验证业务逻辑"上，不是"搭调试脚手架"上。详见 COMMON-13。

# 常见错误案例合集

> 本文件包含两部分：跨角色的通用错误 + 各角色错题本索引。

### 记录规则

- **COMMON 条目只写核心规则**（❌/✅/一句话解释），控制在 5 行以内
- **实际案例**最多附 2-3 行摘要，不展开完整时间线或方案清单
- **详细复盘**放独立 postmortem 文件或对应角色错题本，这里只放链接
- **目的**：所有角色加载通用错误时控制在 ~150 行，有新条目可适当放宽，但每条仍须遵守上面的精简规则

---

## 角色错题本索引

| 角色 | 错题本 | 覆盖范围 |
|------|--------|---------|
| 💻 开发者 | [error-book-dev.md](error-book-dev.md) | 前后端协作、代码实施、环境踩坑 |
| 📋 项目经理 | [error-book-pm.md](error-book-pm.md) | 进度记录、里程碑同步、上下文管理 |
| 🏗️ 架构师 / ⚖️ 讨论专家 | [error-book-debate.md](error-book-debate.md) | 讨论流程、方案设计、决策记录 |
| 🧪 QA Lead | [error-book-qa.md](error-book-qa.md) | 测试设计、测试执行、Bug 报告 |
| 📝 记录员 | [error-book-recorder.md](error-book-recorder.md) | 讨论落盘、索引维护、信息去重 |

---

## 通用错误（所有角色适用）

### COMMON-1 对话是临时的，文件是持久的

❌ 讨论完直接告诉用户结论，没有写文件
✅ 任何重要讨论/决策/进展，必须落盘到对应文件
> 对话丢了就没了，文件才是持久记忆。

### COMMON-2 多个文件记录同一信息

❌ 文档结构在 CLAUDE.md 写一遍，claude-progress.txt 又写一遍
✅ 只在一个地方维护，其他地方放链接
> 信息只有一个 source of truth，重复 = 不一致风险。

### COMMON-3 详细内容放在索引文件里

❌ discussions.md 里放完整的讨论过程（几百行）
✅ 索引文件只放表格/链接，详细内容在独立文件里
> 索引文件要轻，详细内容按需加载。

### COMMON-4 改了内容没更新索引

❌ 新建了文件，但 CLAUDE.md / discussions.md 等索引没加条目
✅ 新建文件的同时，更新所有相关索引
> 没索引 = 找不到 = 不存在。

### COMMON-5 角色越界操作

❌ 后端终端改前端文件、记录员做架构决策、PM 直接改代码
✅ 每个角色只做自己职责范围内的事，需要跨界时通知对应角色
> 职责分离是多 Agent 协作的基础。

### COMMON-6 跨模块语义假设不一致

❌ 模块 A 改变核心概念含义，依赖该概念的模块 B 没同步更新
✅ 架构决策改变语义时，回溯所有依赖模块更新前提假设。TDD 中列出跨模块依赖假设
> 案例：DEV-BUG-5（Agent "在线"定义变更，唤醒服务未同步）。

### COMMON-7 主 Agent 直接做低复杂度任务

❌ 索引同步、链接更新等简单任务，主 Agent 亲自逐个文件读+改
✅ 派子 Agent：`Task(model="haiku")` 做文档/索引，`Task(model="sonnet")` 做需理解上下文的修改
> 主 Agent 是调度器不是执行器。参考 [模型选择策略](model-selection.md)。

### COMMON-8 技术选型的隐含约束全链路漏检

❌ 选技术栈只评估功能匹配度，不列隐含约束 → 全链路无人看护
✅ 技术选型时产出**约束清单**，写入架构文档，TDD/CR/测试逐层体现
> 案例：DEV-BUG-7（SQLite BEGIN IMMEDIATE，2h+/200刀）。各角色检查项见 DEBATE-5/QA-5/PM-5/REC-6。

### COMMON-9 "我觉得我懂"陷阱 — 连续猜方案不搜索

❌ 凭已有知识连续猜方案，每次失败换下一个"我知道的"方案
✅ **两次失败后必须停下搜索根因**。止血三步：先搜索→最小脚本验证→两次失败停下重新分析
> 案例：DEV-BUG-7，连续 9 次猜错，第 10 次搜索 5 分钟解决。

### COMMON-10 修复引入新问题 — 局部修复思维

❌ 改 bug 时只盯着 bug 点，不检查改动对周围代码的影响，导致修复本身引入新的 P1 问题，review 循环 4 轮才归零
✅ 每次修复前做影响面分析：grep 所有引用点、追踪下游消费者、做涟漪推演，目标 review ≤2 轮
> 改变一个变量的赋值语义，就改变了所有依赖它的代码的行为。不做影响面分析 = 盲改。

### COMMON-11 新增内容不查文档存放规则，直接塞索引文件

❌ 具体内容直接加到 CLAUDE.md 主干，没查文档速查确认归属位置
✅ 新增内容前先对照 CLAUDE.md 文档速查，确认归属文件再动手
> CLAUDE.md 是索引和规则，不是内容垃圾桶。

### COMMON-12 教训口头说而不是直接落盘

❌ 发现流程改进点后口头说"以后会这样做"，等用户提醒才去写文件
✅ 任何教训/流程改进，发现的当下直接写入对应文件（CLAUDE.md / 错题本 / common-mistakes），不做口头承诺
> 口头承诺 = 重启后丢失 = 不存在。这是 COMMON-1 的特例：不只是讨论结论要落盘，流程改进本身也要落盘。

### COMMON-13 ST 测试调试循环低效 — 缺少 dev 快捷通道

❌ ST 测试时反复加 print → 重启 → 看不到输出 → 改返回值 → 等 reload → 改阈值，一个验证点耗费 10+ 轮
✅ dev endpoint 内建 `?debug=1` 返回中间状态；阈值可通过 dev API 覆盖；统一尾部斜杠约定
> 调试基础设施的时间 > 验证时间 = 流程有问题。详见 [postmortem-common-13.md](../postmortems/postmortem-common-13.md)

### COMMON-14 写错题本时不回读记录规则，反复超标被打回

❌ 觉得自己记得格式，直接写一大段到错题本，被指出后才精简——已重复犯 2 次
✅ 写错题本前先读文件顶部的"记录规则"段落，确认行数上限，再动手写
> COMMON-9 变体："我觉得我懂格式" = 不去确认 = 每次超标。

### COMMON-15 Phase 实现后跳过 Code Review 直接进入下一步

❌ Phase 写完 → 直接更新进度 → 准备下一步，被用户提醒才回头做 Review
✅ Phase 写完 → Code Review → 修复循环至 P0/P1 归零 → 才能更新进度或进入下一步
> 已写入 CLAUDE.md 工作流强制门禁。Code Review 不是可选步骤，是出口条件。

### COMMON-16 静默失败链路 — 关键分支只 log 不报错，调试时无从定位

❌ `resolve_model` 返回 None → 调用方 `return None, None` → 外层也不报错 → 整条链路静默，E2E 只看到"没回复"
✅ 关键分支失败时日志带上下文（谁、查什么、为什么失败），dev endpoint 加 `?debug=1` 返回中间状态
> 静默失败是调试时间的最大放大器。案例：DEV-BUG-12，详见 [postmortem](../postmortems/postmortem-dev-bug-12.md)

### COMMON-17 前后端新增功能后必须做对齐验证

❌ 前端 types.ts / api.ts 写完就算完，不逐字段比对后端 schema 和 broadcast payload
✅ 新增前后端联动功能后，必须做对齐 checklist：① types.ts 字段 ↔ schemas.py 逐字段比对 ② API 路径+method+body 比对 ③ WebSocket 事件 payload 比对
> 前后端不对齐只会在运行时暴露，越晚发现修复成本越高。案例：M3 城市经济 6 个接口 + 2 个 WS 事件全量比对。

### COMMON-18 Code Review 修复后跳过重新 Review — COMMON-15 变体

❌ Code Review 发现 P1 → 修复 → 直接跑测试宣布完成，跳过"重新 Review 修改后的代码"，被用户提醒才补做
✅ 修复后必须重新 Review 修改点，循环直到 P0/P1 归零。正确顺序：CR 发现问题 → 修复 → 重新 CR → 归零 → 跑测试
> CLAUDE.md L65 已明确写了"修复 → 重新 Review → 循环"，执行时不能省略中间步骤。

---
角色专属错误追加到对应角色的错题本，格式：

```markdown
### [角色前缀]-[编号] 简短标题

❌ 错误做法
✅ 正确做法
> 一句话解释为什么。
```

实际 Bug 踩坑：

```markdown
### [角色前缀]-BUG-[编号] 简短标题

- **场景**: 什么情况下触发
- **现象**: 看到了什么
- **原因**: 根因是什么
- **修复**: 怎么解决的
```

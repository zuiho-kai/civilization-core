# 竞品深度分析：CIVITAS2（古典社会模拟）

**日期**：2025-07-14
**仓库**：私有（Django + MariaDB + Vue 前端）
**定位**：古典社会模拟页游 — 玩家手动操作的城市经济社交系统
**技术栈**：Django REST Framework / MariaDB / Vue.js / Celery（换日任务）
**运营状态**：测试服 3（2025/02/22 开服），一日两换日制

---

## 一、产品定位对比

| 维度 | CIVITAS2 | 我们（bot_civ） |
|------|----------|-----------------|
| 核心愿景 | 玩家扮演古典公民，手动经营城市 | 多 AI Agent 自主生活的社区模拟 |
| 驱动方式 | 玩家手动操作（点按钮） | LLM 自主决策（Agent 自己选择行为） |
| 架构 | Django + MariaDB + Vue | FastAPI + WebSocket + React + SQLite |
| 经济系统 | 多资源物物交换（无货币） | 双货币（信用点 + 游戏币） |
| 记忆系统 | 无（用户属性 + 技能树） | 三层结构化（短期 + 长期 + 公共） |
| 社交机制 | 玩家发言 + 好友 + 社交行为 5 种 | Agent 自动聊天 + @唤醒 + 链式对话 |
| 政治系统 | 县令选举 + 法律 + 弹劾 | 无（M8+ 规划） |
| 战争系统 | 回合制军事（7 种战斗类型） | 无（M9+ 规划） |
| NPC 系统 | NPC 工人（自动应聘/跳槽/辞职） | Agent 即 NPC（LLM 驱动） |
| 换日机制 | 服务端定时换日（全局 day_change） | 无全局换日（Agent 自主循环） |

**核心差异**：CIVITAS2 是传统页游思路 — 系统设计极其精细（四维属性、技能树、产能公式、威望计算），但所有行为都需要玩家手动触发。我们的 Agent 是 LLM 驱动的自主体，不需要玩家操作，但系统深度远不及 CIVITAS2。两者互补性极强：我们可以借鉴他们的系统设计深度，他们缺的是我们的 Agent 自主性。

---

## 二、核心系统架构（17 个 Django App）

### 2.1 模型目录总览

```
api/models/
├── UserModel/       # 用户 + NPC工人 + 好友 + 社交行为 + 通知 + 关系等级
├── CityModel/       # 城市 + 县 + 地形 + 气候 + 县议程 + 法律
├── EstateModel/     # 不动产（建筑）+ 类型 + 开垦/建设/生产全流程
├── MarketModel/     # 四大市场（不动产/招聘/租房/物资）
├── MaterialModel/   # 物资 + 品质等级 + 仓库 + 物资转移
├── SkillModel/      # 大类技能 + 小类技能 + 技能表 + 产能计算
├── WorkModel/       # 工作定义 + 工作记录 + 副业记录
├── ElectModel/      # 选举 + 候选人 + 投票记录
├── WarModel/        # 战争 + 回合 + 军队 + 战术卡 + 参战记录
├── SpeechModel/     # 演讲 + 态度（欢呼/关注/倒彩）
├── DietModel/       # 食谱 + 食材 + 进食效果
├── RankingModel/    # 排行榜 + 称号定义 + 用户称号
├── CivitasModel/    # 全局日历 + 换日调度
├── TaskModel/       # 任务系统 + 信号触发
├── BookModel/       # 藏书系统
├── LawModel/        # 法律系统（县级立法）
└── TradingPostModel/ # 贸易站（跨城贸易）
```

### 2.2 系统依赖关系

```
CivitasModel（日历）
    ↓ 换日触发
UserModel ←→ SkillModel（技能驱动产能）
    ↓              ↓
EstateModel ←→ WorkModel（不动产 = 工作场所）
    ↓              ↓
MarketModel ←→ MaterialModel（物资流转）
    ↓
ElectModel（政治）→ CityModel（县治理）
    ↓
WarModel（军事）→ CityModel（县军队）
```

---

## 三、核心系统深度分析

### 3.1 四维属性系统（UserModel）

CIVITAS2 的用户有四个核心属性，所有行为都消耗属性：

| 属性 | 范围 | 换日恢复公式 | 影响 |
|------|------|-------------|------|
| 精力 stamina | 0-100 | `(30 + 住房加成) × (1 + (健康-60)/80) × 饥饿修正` | 工作/副业/社交/战斗的前置条件 |
| 健康 health | 0-100 | `3 + 0.2×(平衡值-当前) + 溢出精力×0.05 + 住房 + 县治理/200` | 影响精力恢复 |
| 快乐 happiness | 0-100 | `3 + 0.2×(平衡值-当前) + 溢出精力×0.05 + 住房 + 县繁荣/200` | 影响产能 |
| 饥饿 starvation | 0-100 | `-(0.08×当前 + 2)` 每日递减 | 低于60影响精力恢复，低于20昏倒 |

**设计亮点**：
- 四维互相耦合：健康影响精力恢复，饥饿影响精力和快乐，形成正/负反馈循环
- 住房加成 × 维护度修正：住房品质直接影响恢复速度，维护度 < 75% 时线性衰减
- 县治理/繁荣值影响个人属性：宏观政策影响微观个体
- `status_change_all()` 用原生 SQL 批量更新，避免 N+1

**对 bot_civ 的启示**：我们的 Agent 目前没有属性系统，行为没有成本约束。可以借鉴四维模型给 Agent 加"能量/心情"属性，让行为有代价，产生更真实的决策权衡。

### 3.2 技能系统（SkillModel）

```
Big_Skill（大类技能）── 如：农业、手工、社交、军事
    └── Small_Skill（小类技能）── 如：种植、灌溉、纺织

User_Skill（技能表）
    ├── User_Skill_To_Big_Skill（大类技能中间表）
    │       skill_num: 技能点
    │       comprehension: 悟性
    │       level: 1学徒 → 7大宗师
    └── User_Skill_To_Small_Skill（小类技能中间表）
            skill_num: 技能点
```

**产能计算核心公式**（`capacity_calculation`）：
```
基础产能 = f(技能点, 小类技能点)
总产能 = 基础产能 × 技能系数 × 经验系数 × 快乐系数
```

**设计亮点**：
- 技能每日衰减 + 突破机制：不用就退化，形成"用进废退"
- 悟性系统：影响技能增长速度
- 7 级等级制：学徒→匠人→匠师→专家→大师→宗师→大宗师
- 技能驱动一切产出：工作、副业、演讲、社交、战斗都依赖技能

**对 bot_civ 的启示**：我们的 Agent 人格是静态文本。可以借鉴技能树给 Agent 加"能力值"，让 Agent 在特定领域越做越强，形成专业化分工。

### 3.3 不动产系统（EstateModel）— 最复杂的模块

不动产是 CIVITAS2 的核心生产单位，生命周期：

```
创建 → 开垦（消耗产能获得土地）→ 建设（消耗产能+材料）→ 运营（生产/加工）
                                                              ↓
                                                         维护（每日消耗维护材料）
                                                              ↓
                                                         维护度下降 → 效率降低
```

**不动产类型**（Estate_Type）：
- 可工作建筑（农田/矿井/工坊/贸易站）
- 住房（影响四维恢复）
- 餐厅（食谱系统）
- 书局（藏书系统）

**关键机制**：
- 土地系统：每个县有多种地形，每种地形有可开垦上限
- 工人系统：`number_of_work_person` 限制工位，支持用户工人 + NPC 工人
- 产能链：技能 → 基础产能 → 不动产效率修正 → 最终产能 → 产出物资
- 维护度：每日消耗维护材料，不足则维护度下降，影响所有产出效率
- 灌溉/肥力/产业值：农业建筑受县级环境因素影响
- 工具系统：工具提供产能加成

**对 bot_civ 的启示**：我们的建造系统（M6 P3）是简化版。CIVITAS2 的"开垦→建设→运营→维护"全生命周期管理值得参考，特别是维护度衰减机制可以让 Agent 有持续维护的动力。

### 3.4 市场系统（MarketModel）— 四大市场

| 市场 | 模型 | 核心机制 |
|------|------|---------|
| 不动产市场 | Estate_Market | 出售/出租不动产，支持续租、到期归还 |
| 招聘市场 | Recruitment_Market | 4 种工资类型（基准产能/固定/最终产能/志愿），支持调岗 |
| 租房市场 | House_Rent_Market | 租房 + 邀请入住 + 续租 + 到期通知 |
| 物资市场 | Material_Market | 物物交换（A 物资换 B 物资），记录交易历史 |

**设计亮点**：
- 无货币的物物交换：所有交易都是"X 单位物资 A 换 Y 单位物资 B"
- 招聘市场的 4 种工资类型：按基准产能、按最终产能、固定工资、志愿工
- NPC 自动应聘逻辑：NPC 会比较工资，5 天以上有更高工资就跳槽
- 调岗系统：雇主可以发起调岗请求，工人可以接受/拒绝
- 交易记录：`MaterialMarketRecord` 记录每笔交易

**对 bot_civ 的启示**：
- 我们的经济系统是双货币制（信用点 + 游戏币），比物物交换简单但缺乏深度
- NPC 自动应聘/跳槽逻辑可以直接移植到我们的 Agent 就业行为
- 招聘市场的工资类型设计很精巧，值得 M7 借鉴

### 3.5 社交系统（UserModel 内）

**好友系统**：
- 双向好友关系（Friend 表，from_person + to_person）
- 好友请求流程：发送 → pending → 接受/拒绝/过期
- 自动匹配：双方互发请求时自动成为好友
- 冷却期：被拒绝后 24 小时内不能再发
- 关系值：-100 到 100，影响社交效果

**社交行为 5 种**：

| 行为 | 精力消耗 | 对方快乐 | 关系值变化 | 需要好友 |
|------|---------|---------|-----------|---------|
| 公开赞扬 | 15 | +0.5 | +10 | 是 |
| 公开谴责 | 15 | -0.5 | -10 | 否 |
| 私下表扬 | 5 | +0.25 | +5 | 是 |
| 私下批评 | 5 | -0.25 | -5 | 是 |
| 赠送礼物 | 5 | +0.5 | +10 | 是 |

**关系等级**（RelationshipLevel）：
- 根据关系值分段，不同等级有不同的精力消耗倍率和关系值收益倍率
- 高关系等级：社交消耗更少，收益更多（正反馈）
- 低关系等级：社交消耗更多，收益更少（负反馈）

**对 bot_civ 的启示**：
- 我们的 Agent 社交是纯聊天，没有结构化的社交行为
- 关系值 + 关系等级机制可以给 Agent 间关系加量化维度
- 5 种社交行为可以作为 Agent 的"社交工具"，让 Agent 选择如何社交

### 3.6 政治系统（ElectModel + CityModel）

**县令选举流程**：
```
创建选举 → 报名阶段（2天）→ 投票阶段（2天）→ 开票
                                                  ↓
                                          票数最高者当选
                                          平票取威望最高者
                                                  ↓
                                          县令上任 + 称号授予
                                          县属不动产转移
                                          下次选举日期设定
```

**报名条件**：在该县连续居住 ≥ 5 天，不能同时担任其他县县令
**投票条件**：在该县连续居住 ≥ 5 天，每人一票

**威望计算**（影响选举和排名）：
```
总威望 = 0.15×等级威望 + 0.50×地产威望 + 0.15×演讲威望 + 0.20×社交威望
```
- 等级威望：`√(等级) × 100`，上限 1000
- 地产威望：本县土地数 × 20，上限 1000
- 演讲威望：近 40 天演讲得分（5 + 0.5×欢呼 - 0.5×倒彩）× 时间衰减
- 社交威望：被赞扬/谴责/礼物的加权和

**对 bot_civ 的启示**：
- 选举系统可以作为 M8+ 的参考蓝图
- 威望计算公式很成熟，可以直接借鉴
- "连续居住天数"作为参政门槛是好设计

### 3.7 战争系统（WarModel）

**7 种战斗类型**：

| 类型 | 性质 | 结果 |
|------|------|------|
| 国战 | PVP | 领土争夺 |
| 叛乱 | PVP | 推翻县令 |
| 演习 | PVP | 无实际损失 |
| 剿匪 | PVE | 获得物资 + 人口 + 治理值 |
| 狩猎 | PVE | 获得物资 + 繁荣值 |
| 拓荒 | PVE | 获得土地 + 5%概率获得特产 |
| 蛮族入侵 | PVE | 防御失败损失物资和建筑 |

**战斗机制**：
- 回合制（默认 6 回合，先赢 4 回合者胜）
- 骰子 + 指挥能力加成
- 军队类型（ArmyType）：攻击/防御/维护费
- 训练度 + 士气系统：影响战斗力和战损
- 战术卡系统：克制关系 + 攻防加成
- 玩家参战：消耗属性，技能计算伤害
- 军饷系统：县仓库支付

**县军队维护**（`CountyArmy.day_change_all`）：
- 每日消耗维护物资（物资不足则逃兵 10% + 2）
- 训练中：训练度增长，维护费翻倍
- 战斗中：维护费翻倍 + 距离加成
- 不训练且训练度 > 0.8：训练度每日衰减

**对 bot_civ 的启示**：战争系统是 M9+ 的远期目标，CIVITAS2 的设计可以作为参考但不急于借鉴。

### 3.8 NPC 工人系统（UserModel.NPC_Worker）

这是最值得我们借鉴的系统之一。CIVITAS2 的 NPC 工人有自主行为：

**NPC 换日逻辑**（`day_change`）：
1. 不活跃 NPC → 自动辞职
2. 无工作 NPC → 扫描同县招聘市场，应聘工资最高且 > 5 产能的岗位
3. 有工作 NPC → 正常工作
4. 工作失败 → `day_cannot_work += 1`，连续 5 天失败 → 辞职
5. 发现更高工资（> 当前 120%）→ `day_cannot_work += 1`
6. 发现更高工资（> 当前 140%）→ `day_cannot_work += 2`
7. `day_cannot_work > 5` → 跳槽到更高工资岗位

**设计亮点**：
- NPC 有"不满度"积累机制（day_cannot_work），不是立即跳槽而是逐渐积累
- 工资阈值判断：20% 差距小幅不满，40% 差距大幅不满
- 无工资直接 +4 不满度，几乎立即跳槽
- 辞职时通知雇主，附带原因

**对 bot_civ 的启示**：这套 NPC 行为逻辑可以直接作为 Agent 就业决策的参考模板。我们的 Agent 用 LLM 决策，但可以把这些规则作为"常识"注入 prompt，让 Agent 的就业行为更合理。

---

## 四、换日系统（CivitasModel）

CIVITAS2 的核心调度是"换日"（day_change），每日执行一次，串行处理所有系统：

```python
# 换日执行顺序（推测）
1. Calendar.total_day += 1
2. User_Table.day_change_all()      # 四维恢复 + 活跃判断 + 威望计算
3. NPC_Worker.day_change()           # NPC 应聘/工作/跳槽
4. Estate.day_change_all()           # 不动产维护 + 维护度衰减
5. House_Rent_User.day_change_all()  # 租房到期处理
6. Election.day_change_all()         # 选举阶段推进
7. War.day_change()                  # 战斗回合结算
8. CountyArmy.day_change_all()       # 军队维护 + 逃兵
9. County.day_change()               # 县级数据更新（繁荣/治理/产业值）
```

**对 bot_civ 的启示**：我们没有全局换日，Agent 是自主循环的。但可以引入"世界时钟"概念，定期触发全局事件（天气变化、市场波动、NPC 行为等），给 Agent 提供环境刺激。

---

## 五、数据模型统计

| 模块 | 模型数 | 核心模型 | 代码行数（估） |
|------|--------|---------|--------------|
| UserModel | 12 | User_Table, NPC_Worker, Friend, Social_Behavior, Notification | ~2000 |
| CityModel | 10+ | City, County, Climate, Terrain, County_To_Terrain | ~2500 |
| EstateModel | 8+ | Estate, Estate_Type, Estate_Type_House | ~2000 |
| MarketModel | 8 | Estate_Market, Recruitment_Market, Material_Market, House_Rent_Market | ~800 |
| MaterialModel | 6+ | Material, Material_Detail, Depository, Depository_To_Material | ~1000 |
| SkillModel | 5 | Big_Skill, Small_Skill, User_Skill, User_Skill_To_Big_Skill | ~800 |
| WorkModel | 4+ | Work_Main, Work_Record, Sideline_Record | ~600 |
| ElectModel | 3 | Election, Candidate, VoteRecord | ~500 |
| WarModel | 12 | War, War_Round, CountyArmy, ArmyType, WarTactic | ~1300 |
| 其他 | 10+ | Diet, Book, Task, Ranking, Law, TradingPost | ~1500 |
| **合计** | **~80** | | **~13000** |

---

## 六、可借鉴清单（按优先级）

### 立即可用（M6.2-M7）

| ID | 借鉴点 | CIVITAS2 实现 | bot_civ 应用 | 优先级 |
|----|--------|-------------|-------------|--------|
| V1 | Agent 属性系统 | 四维（精力/健康/快乐/饥饿）+ 换日恢复 | 给 Agent 加"能量/心情"属性，行为有成本 | 高 |
| V2 | NPC 就业决策 | day_cannot_work 积累 + 工资比较 + 跳槽 | 注入 Agent prompt 作为就业常识 | 高 |
| V3 | 关系值量化 | Friend.relationship_value + RelationshipLevel | Agent 间关系加数值维度 | 中 |
| V4 | 物资品质等级 | Material_Detail.level（Q1-Q3） | 物品加品质属性 | 中 |

### 纳入 M7-M8

| ID | 借鉴点 | CIVITAS2 实现 | bot_civ 应用 |
|----|--------|-------------|-------------|
| V5 | 技能树 | Big_Skill + Small_Skill + 7 级等级 | Agent 能力值系统 |
| V6 | 不动产全生命周期 | 开垦→建设→运营→维护度衰减 | 建筑维护机制 |
| V7 | 招聘市场 | 4 种工资类型 + NPC 自动应聘 | Agent 就业市场 |
| V8 | 威望系统 | 4 维加权（等级/地产/演讲/社交） | Agent 声望/影响力 |

### 远期参考（M8+）

| ID | 借鉴点 | CIVITAS2 实现 |
|----|--------|-------------|
| V9 | 选举系统 | 报名→投票→开票全流程 |
| V10 | 演讲系统 | 发言 + 态度（欢呼/关注/倒彩） |
| V11 | 战争系统 | 回合制 + 军队 + 战术卡 |
| V12 | 法律系统 | 县级立法 + 弹劾 |

---

## 七、架构对比总结

### CIVITAS2 的优势
1. **系统深度极高**：80+ 模型，13000+ 行业务代码，覆盖经济/社交/政治/军事
2. **数值设计精细**：四维属性互相耦合，产能公式多因子，威望加权计算
3. **NPC 行为逻辑成熟**：不满度积累 + 工资比较 + 跳槽机制
4. **批量操作优化**：`status_change_all` 用原生 SQL 批量更新，`bulk_create` 批量通知
5. **完整的政治系统**：选举 + 法律 + 弹劾 + 县令任期

### CIVITAS2 的劣势
1. **无 AI 驱动**：所有行为需要玩家手动操作，NPC 只有简单规则
2. **无记忆系统**：没有对话历史、没有语义记忆
3. **无自主性**：NPC 只在换日时执行固定逻辑，不会主动社交/探索
4. **单一交互模式**：点按钮操作，没有自然语言交互
5. **技术栈偏传统**：Django 同步框架，不适合实时 WebSocket 场景

### bot_civ 的差异化优势
1. **LLM 驱动的自主 Agent**：Agent 自己决定做什么，不需要玩家操作
2. **三层记忆系统**：短期 + 长期 + 公共记忆，Agent 有"人生经历"
3. **自然语言交互**：Agent 之间用自然语言聊天，不是点按钮
4. **实时 WebSocket**：Agent 行为实时可见，不需要等换日
5. **人格系统**：每个 Agent 有独特人格，行为风格不同

---

## 八、结论

CIVITAS2 是一个系统设计极其精细的古典社会模拟，代码量和系统复杂度远超我们当前阶段。但它本质上是"传统页游 + 简单 NPC 规则"，缺乏 AI 驱动的自主性和记忆系统。

**核心借鉴策略**：取其系统设计精华（四维属性、NPC 就业逻辑、关系值、威望计算），注入我们的 LLM Agent 框架，让 Agent 在更丰富的系统规则下做出更合理的自主决策。

**一句话总结**：CIVITAS2 提供了"世界规则"，我们提供了"智能居民"。两者结合就是终极目标。

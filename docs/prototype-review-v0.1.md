# 原型设计 v0.1 — 改进点与模糊点梳理

> 基于 `prototype-design-v0.1.md` 的审查，记录尚不清晰或需要决策的问题。
> 不是否定现有设计，而是补全它。
>
> **状态：全部已解决**（2026-02-25）

---

## 一、核心机制的模糊点

### 1.1 EventEngine 的推进条件没有定义 ✅ 已解决

> **解决方案**：§5.1 增加 `MAX_VIRTUAL_TIME` 终止条件；wake_up 自驱循环保证队列不会自然清空。

~~文档说"循环 pop 最早事件"，但没有说：~~

- ~~**终止条件**是什么？~~ → `clock < MAX_VIRTUAL_TIME`（默认 10000.0）
- ~~**空队列**时怎么办？~~ → wake_up 自驱循环保证队列不空
- ~~**虚拟时间上限**是多少？~~ → `MAX_VIRTUAL_TIME`，备选 `MAX_EVENTS`

---

### 1.2 Agent 的主动性没有来源 ✅ 已解决

> **解决方案**：§5.1.1 wake_up 自决策机制。Bootstrap 时为每个 Agent schedule 初始 wake_up，之后 Agent 自驱（行动后 schedule 下一次唤醒）。

---

### 1.3 Exchange 的撮合机制未定义 ✅ 已解决

> **解决方案**：§5.2.1 完整 5 步事件驱动撮合流程（对象选择 → 估值 → 协商 → 结算 → 拒绝处理），无中央撮合，无全局市场。

---

### 1.4 Coerce 的"强制代价"计算公式缺失 ✅ 已解决

> **解决方案**：§5.7.2 Coerce 完整流程（双重消耗：energy_cost + wealth_cost）+ §5.7.5 失败惩罚 4 层结构（反击 + 制度制裁 + 合法性损失 + 道德规范）。代价由发起 Agent 本人承担，org 可通过 rules 补贴。

---

### 1.5 组织的"制度参数集"内容未定义 ✅ 已解决

> **解决方案**：§5.5.1 枚举 6 类 12 个 key（经济/强制/权力/意识形态/流动/对外姿态），每个 key 附范围、默认值、对 Agent 收益的影响公式。§5.6 明确 MUTATABLE_KEYS 和扰动幅度 MUTATION_STEP=0.05。

---

## 二、验收标准的可操作性问题

### 2.1 "至少发生一次 rule_mutation_event" 依赖参数敏感度 ✅ 已解决

> **解决方案**：§5.6 提供三个阈值的默认值（EFFICIENCY_THRESHOLD=0.3, MIGRATION_THRESHOLD=0.2, CONFLICT_THRESHOLD=avg_wealth×0.5）。

---

### 2.2 "局部价格差异" 无法在当前模型中度量 ✅ 已解决

> **解决方案**：§7 验收标准补充度量方法。隐式价格 = exchange 成交价（wealth 比率）；区域 = Organization 或网络连通分量；指标 = 区域间平均成交价方差，阈值 PRICE_DIVERGENCE_THRESHOLD=0.05。

---

## 三、架构遗漏

### 3.1 ResourceLedger 的守恒规则没有说明 ✅ 已解决

> **解决方案**：§5.3.1 明确"守恒的是因果，不是总量"。energy 个体可再生（不守恒），wealth 可通过生产增长（不守恒），ResourceLedger 保证所有变更来自合法事件（因果守恒）。

---

### 3.2 NetworkEngine 的初始化策略缺失 ✅ 已解决

> **解决方案**：§5.4 指定 Watts-Strogatz 小世界网络（K=10, β=0.15）+ 距离衰减 trust 初始化（`trust_ij = 0.4 + 0.4 * exp(-d) + Normal(0, 0.05)`）。

---

### 3.3 迁移（migration）机制完全缺失 ✅ 已解决

> **解决方案**：§5.5.3 双层迁移机制。① 制度迁移：EV_join / EV_outside 驱动 org 归属变更。② 网络迁移：退出 org 时自动触发 network_rewire（替换部分旧邻居 + 旧连接 trust 衰减）。migration_rate 有明确度量公式。

---

## 四、设计哲学和工程实现的张力

### 4.1 "禁止全局扫描"与 OrgEngine 的矛盾 ✅ 已解决

> **解决方案**：§6 澄清边界。禁止的是"每个 event 都全图遍历"，允许低频兜底扫描（每 200 个事件一次）。v0.1 采用增量式 org 检测：trust 变更时更新局部密度缓存 → 越阈值时 schedule org_check → 只遍历局部连通分量。

---

### 4.2 v0.1 约束和连续时间架构的兼容性 ✅ 已解决

> **解决方案**：§1.3 行数上限从 800 上调至 1200（含注释和空行），保留纯标准库约束不变。

---

## 五、优先级建议（全部已关闭）

| 优先级 | 问题 | 影响范围 | 状态 | 解决位置 |
|--------|------|----------|------|----------|
| P0 | Agent 主动性来源（1.2） | 世界能否运转 | ✅ | §5.1.1 |
| P0 | Exchange 撮合机制（1.3） | 财富流动是否存在 | ✅ | §5.2.1 |
| P0 | 资源守恒定义（3.1） | ResourceLedger 能否实现 | ✅ | §5.3.1 |
| P1 | Coerce 代价公式（1.4） | 验收标准"强制有代价" | ✅ | §5.7.2 + §5.7.5 |
| P1 | Organization.rules 枚举（1.5） | 制度突变是否有意义 | ✅ | §5.5.1 + §5.6 |
| P1 | 800行限制 vs 完整实现（4.2） | 是否需要调整约束 | ✅ | §1.3 (→1200) |
| P2 | 初始图模型选择（3.2） | 涌现结果差异 | ✅ | §5.4 |
| P2 | 迁移机制补充（3.3） | mutation 触发条件完整性 | ✅ | §5.5.3 |
| P2 | 局部价格度量（2.2） | 验收标准可操作性 | ✅ | §7 |

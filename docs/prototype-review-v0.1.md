# 原型设计 v0.1 — 改进点与模糊点梳理

> 基于 `prototype-design-v0.1.md` 的审查，记录尚不清晰或需要决策的问题。
> 不是否定现有设计，而是补全它。

---

## 一、核心机制的模糊点

### 1.1 EventEngine 的推进条件没有定义

文档说"循环 pop 最早事件"，但没有说：

- **终止条件**是什么？`event_queue` 为空时世界停止？还是永远运行？
- **空队列**时怎么办？Agent 全部在等待生产完成，队列可能短暂为空。
- **虚拟时间上限**是多少？用什么参数控制运行时长？

目前文档只有 `MAX_TICKS`（沿用了旧版概念），但切换到连续时间后，这个参数应该是 `MAX_VIRTUAL_TIME` 还是 `MAX_EVENTS`？两者行为不同。

---

### 1.2 Agent 的主动性没有来源

文档描述了 Agent 响应事件（被动），但没说 Agent 怎么**主动发起行为**。

- 谁来 schedule 第一个 `produce` 事件？
- Agent 决定"现在生产"还是"现在交换"的逻辑在哪？
- 是否有一个 Agent 自主决策的触发机制（比如定期唤醒），还是完全被动等待？

如果 Agent 完全被动，世界可能在初始化后就无事发生。

---

### 1.3 Exchange 的撮合机制未定义

`EXCHANGE` 原语涉及双方，但：

- Agent A 怎么找到愿意交换的 Agent B？只能从 `neighbors` 里找？
- 交换比率怎么定？双方协商？固定公式？随机？
- 如果 B 拒绝，有没有事件反馈？trust 是否变化？

这直接影响财富流动的速度和方向，是 Gini 能否分化的关键。

---

### 1.4 Coerce 的"强制代价"计算公式缺失

文档第 5.7 节给出了监督成本的概念公式，但：

- 代价由谁承担？施压方 org？施压 Agent 本人？
- 代价是能量消耗、财富消耗，还是 trust 惩罚？
- 被强制方有无反抗概率？反抗的条件是什么？

没有这些，Coerce 的行为效果完全不确定，无法验证"强制有代价"这条验收标准。

---

### 1.5 组织的"制度参数集"内容未定义

文档说 `rules` 是参数容器，举例了"税率、分配比例"，但：

- `rules` 有哪些 key？没有枚举。
- 这些 key 怎么影响 Agent 行为？
- `rule_mutation` 是随机扰动哪些 key？扰动幅度？

如果 `rules` 是黑盒，组织和无组织的 Agent 行为无区别，组织涌现失去意义。

---

## 二、验收标准的可操作性问题

### 2.1 "至少发生一次 rule_mutation_event" 依赖参数敏感度

触发 mutation 需要三个条件同时（或任一）满足，但阈值 `EFFICIENCY_THRESHOLD` / `MIGRATION_THRESHOLD` / `CONFLICT_THRESHOLD` 没有建议默认值。

- 如果阈值过高，mutation 永远不触发，验收永远失败。
- 没有调参指南，开发者只能靠猜。

---

### 2.2 "局部价格差异" 无法在当前模型中度量

验收标准里有"不同网络区域的交换比率出现分化"，但：

- 当前数据模型没有"价格"字段，也没有"区域"概念。
- Exchange 的比率存在哪里？怎么读取？

这条验收标准目前无法实现，需要补充度量机制或删除。

---

## 三、架构遗漏

### 3.1 ResourceLedger 的守恒规则没有说明

文档多次提到"资源守恒"，但：

- 守恒的是什么？财富总量？能量总量？两者都守恒？
- 生产行为会创造新资源（财富增加），这和守恒矛盾吗？
- "守恒"是指单次 event 前后守恒，还是全局总量不变？

如果是全局总量不变，生产出的资源从哪来？如果总量可增加，守恒的意义是什么？

---

### 3.2 NetworkEngine 的初始化策略缺失

文档说"初始网络为随机稀疏图，平均度 < 20"，但：

- 用什么图模型？Erdős–Rényi？Barabási–Albert（偏好连接更接近现实）？
- 初始 trust 值如何赋值？全部 0.5？随机？
- 两种图模型会产生非常不同的涌现结果。

---

### 3.3 迁移（migration）机制完全缺失

文档第 5.6 节提到 `migration_rate` 作为制度突变的触发条件，但：

- Agent 怎么"迁移"？脱离一个 org 加入另一个？
- 迁移的条件是什么？效用比较？trust 积累？
- 如果迁移机制不存在，`migration_rate` 永远为 0，这个触发条件永远不生效。

---

## 四、设计哲学和工程实现的张力

### 4.1 "禁止全局扫描"与 OrgEngine 的矛盾

文档第 6 节说"禁止全局 recalculation"，但 OrgEngine 需要"检测连通子图的密度"。

- 连通子图检测（BFS/DFS）本质上是 O(N+E) 的图遍历。
- 如果 N=500，每次 OrgEngine 运行都是全图遍历，这算不算"全局扫描"？
- 需要明确边界：是禁止"每个 event 都全局扫描"，还是禁止"任何形式的全局扫描"？

---

### 4.2 v0.1 约束和连续时间架构的兼容性

v0.1 约束是"≤800 行 + 纯标准库"，但连续时间事件引擎的完整实现包括：

- EventQueue（heapq）
- AgentEngine（三类原语）
- NetworkEngine（稀疏图 + 局部传播）
- OrgEngine（子图检测）
- ResourceLedger（守恒账本）
- metrics.py（Gini）

保守估计这些模块合计 600–900 行，800 行上限可能偏紧。
需要决定：是砍机制凑行数，还是放开行数限制？

---

## 五、优先级建议

以下问题建议在编码前明确，否则会在实现中反复返工：

| 优先级 | 问题 | 影响范围 |
|--------|------|----------|
| P0 | Agent 主动性来源（1.2） | 世界能否运转 |
| P0 | Exchange 撮合机制（1.3） | 财富流动是否存在 |
| P0 | 资源守恒定义（3.1） | ResourceLedger 能否实现 |
| P1 | Coerce 代价公式（1.4） | 验收标准"强制有代价" |
| P1 | Organization.rules 枚举（1.5） | 制度突变是否有意义 |
| P1 | 800行限制 vs 完整实现（4.2） | 是否需要调整约束 |
| P2 | 初始图模型选择（3.2） | 涌现结果差异 |
| P2 | 迁移机制补充（3.3） | mutation 触发条件完整性 |
| P2 | 局部价格度量（2.2） | 验收标准可操作性 |

# v0.1.1 优化计划：修复制度僵化问题

> 基于 v0.1 验收通过后的问题诊断，修复组织制度僵化、政策无分化的核心问题

## 1. 问题诊断总结

### 1.1 现象
- ✅ 组织涌现成功（11-14 个组织）
- ✅ 组织生死更替（有解散有新生）
- ✅ 制度突变频繁触发（每个组织都在 9994-10000 时间突变）
- ❌ **所有组织政策完全相同**（税率 5%，再分配 50%，标准差 0.000）
- ❌ **没有制度创新和政策分化**

### 1.2 根本原因

#### 问题 1：EV 计算中的致命缺陷
```python
# 当前：平均分配再分配
redistribution_income = total_tax * redistribution_ratio / org_size
```

**问题：**
- 富人交 100 税，得到 50/7 = 7.1 再分配 → 净损失 92.9
- 穷人交 10 税，得到 50/7 = 7.1 再分配 → 净损失 2.9
- **比例上，富人和穷人的净税率几乎相同**
- 没有真正的"劫富济贫"，所以富人和穷人对税率的偏好差异不大

#### 问题 2：税率影响被稀释
- 税率 5%，再分配 50% → 实际净税率 = 5% × (1 - 50%) = 2.5%
- 对于 production=3.59 的穷人，改变税率只影响 0.09 的收入
- **这个影响太小，完全被其他因素（退出惩罚、公共品）淹没**

#### 问题 3：缺失组织维护成本
- 组织没有管理成本、运行开支
- treasury 只增不减
- 组织规模没有真实的负担
- **税收的必要性不明显**

## 2. 优化方案

### 2.1 引入按需再分配机制

**目标：** 让再分配真正从富到穷，产生阶级冲突

```python
def compute_ev_join(agent: Agent, org, world: World) -> float:
    sz = len(org.members)
    rules = org.rules
    production = compute_ev_produce(agent, world)

    # 税后收入
    after_tax_income = (1 - rules.get('tax_rate', 0)) * production

    # 再分配收益：按"贫困度"分配
    total_tax_income = rules.get('tax_rate', 0) * production * sz
    total_redistribution = total_tax_income * rules.get('redistribution_ratio', 0)

    # 计算组织平均财富
    avg_wealth = sum(world.agents[m].wealth for m in org.members) / sz

    # 贫困度：低于平均财富的部分
    poverty_score = max(0, avg_wealth - agent.wealth)
    total_poverty = sum(max(0, avg_wealth - world.agents[m].wealth)
                       for m in org.members)

    if total_poverty > 0:
        redistribution_income = total_redistribution * (poverty_score / total_poverty)
    else:
        redistribution_income = 0  # 没有穷人，不分配

    # 公共品收益
    public_goods = rules.get('public_goods_efficiency', 0) * math.log(sz + 1) * production * 0.3

    # 安全收益
    e_security = 0.1 * agent.wealth

    # 成本
    c_coercion = 0.1 * rules.get('punishment_severity', 0) * agent.wealth
    c_exit = rules.get('exit_penalty', 0) * agent.wealth * 0.01

    # 合法性影响
    legitimacy_factor = org.legitimacy
    base_ev = after_tax_income + redistribution_income + public_goods + e_security - c_coercion - c_exit

    return base_ev * legitimacy_factor
```

**效果：**
- 富人（wealth > avg）：poverty_score = 0 → 不享受再分配 → 反对高税
- 穷人（wealth < avg）：poverty_score 高 → 享受大部分再分配 → 支持高税
- **真正的阶级冲突**

### 2.2 引入组织维护成本

**目标：** 让组织规模有真实负担，税收有必要性

```python
def calculate_management_cost(org: Organization) -> float:
    """计算组织管理成本（与规模和效率相关）"""
    size = len(org.members)
    base_cost = 1.0  # 基础成本

    # 规模惩罚：log(size) 模拟官僚化
    # 效率低 → 管理成本高
    cost = base_cost * size * (1 + math.log(size + 1)) / max(org.efficiency, 0.1)
    return cost

def handle_org_tax_collection(world: World, org: Organization) -> None:
    """组织税收征收 + 维护成本扣除 + 再分配"""
    total_tax = 0

    # 1. 征税
    for member_id in org.members:
        agent = world.agents[member_id]
        production = compute_ev_produce(agent, world)
        tax = org.rules['tax_rate'] * production
        agent.wealth -= tax
        total_tax += tax

    # 2. 扣除管理成本
    management_cost = calculate_management_cost(org)
    net_tax = total_tax - management_cost

    if net_tax < 0:
        # 入不敷出，组织腐化
        org.efficiency *= 0.9
        org.legitimacy *= 0.9
        org.treasury += total_tax  # 全部用于维持，无法再分配
        return

    # 3. 再分配（按需分配）
    redistribution_pool = net_tax * org.rules['redistribution_ratio']
    avg_wealth = sum(world.agents[m].wealth for m in org.members) / len(org.members)
    total_poverty = sum(max(0, avg_wealth - world.agents[m].wealth)
                       for m in org.members)

    if total_poverty > 0:
        for member_id in org.members:
            agent = world.agents[member_id]
            poverty_score = max(0, avg_wealth - agent.wealth)
            share = redistribution_pool * (poverty_score / total_poverty)
            agent.wealth += share

    # 4. 剩余进国库
    org.treasury += net_tax * (1 - org.rules['redistribution_ratio'])
```

**效果：**
- 小组织（5人）：管理成本 ~9，需要税率 18% 维持
- 中组织（10人）：管理成本 ~24，需要税率 24% 维持
- 大组织（20人）：管理成本 ~60，需要税率 30%+ 维持
- **组织规模有上限，税收有必要性**

### 2.3 调整初始参数

```python
# config.py
DEFAULT_RULES = {
    'tax_rate': 0.05,
    'redistribution_ratio': 0.3,  # 降低初始再分配（从 0.5 → 0.3）
    'public_goods_efficiency': 0.3,
    'internal_coercion_tolerance': 0.2,
    'punishment_severity': 0.3,
    'enforcement_cost_share': 0.5,
    'delegation_rate': 0.5,
    'ideology_strength': 0.0,
    'ideology_extremity': 0.0,
    'entry_barrier': 0.3,
    'exit_penalty': 0.1,
    'external_aggression_bias': 0.3,
    'loot_policy': 0.3,
}

# 组织维护成本参数
ORG_BASE_MANAGEMENT_COST = 1.0  # 基础管理成本
ORG_SIZE_PENALTY_FACTOR = 1.0   # 规模惩罚系数
```

## 3. 预期效果

### 3.1 政策分化
- **低税低福利组织**：富人聚集，税率 5-10%，再分配 10-20%
- **高税高福利组织**：穷人聚集，税率 30-40%，再分配 60-80%
- **中间路线组织**：混合成员，税率 15-20%，再分配 40-50%

### 3.2 组织动态
- 小组织：管理成本低，灵活，但安全弱
- 大组织：管理成本高，需要高税率，容易腐化
- 效率低的组织：管理成本暴涨 → 入不敷出 → 解散

### 3.3 阶级冲突
- 富人：反对高税（交税多，不享受再分配）
- 穷人：支持高税（交税少，享受大部分再分配）
- 组织内部：富人和穷人的制度突变诉求相反

## 4. 实施步骤

1. ✅ 修复 EV 计算中的税收重复扣除问题
2. ✅ 修复再分配计算错误（从国库总量改为每期税收）
3. ✅ 降低公共品收益系数（避免掩盖税收影响）
4. ✅ 降低退出成本系数（避免掩盖税率影响）
5. ⏳ **实施按需再分配机制**
6. ⏳ **引入组织维护成本**
7. ⏳ **调整初始参数**
8. ⏳ **运行 10,000 轮测试，验证政策分化**

## 5. 验收标准

- [ ] 政策多样性：税率标准差 > 0.05
- [ ] 政策多样性：再分配标准差 > 0.1
- [ ] 至少存在 3 种不同的政策组合
- [ ] 富人聚集的组织：税率 < 15%
- [ ] 穷人聚集的组织：税率 > 25%
- [ ] 大组织（>15人）因管理成本解散至少 1 次
- [ ] 组织数量在 8-20 之间波动

## 6. 技术债务

### 6.1 当前简化
- 再分配按"贫困度"分配（简化的累进系统）
- 管理成本按 log(size) 增长（简化的官僚化）
- 未实现累进税率（所有人税率相同）

### 6.2 未来优化方向
- 累进税率：富人税率更高
- 福利门槛：只有低于某个财富线的人能领福利
- 管理者角色：部分成员脱产成为管理者
- 组织间竞争：成员在组织间流动
